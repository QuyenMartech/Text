#!/bin/bash
# ================================================================
# Script: 3proxy + Cloudflare WARP (COMBINED VERSION)
# K·∫øt h·ª£p ƒë·∫ßy ƒë·ªß logic t·ª´ script g·ªëc + script WARP
# ================================================================

if [ "$(id -u)" != "0" ]; then
    echo "This script must be run as root" 1>&2
    exit 1
fi

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${GREEN}============================================${NC}"
echo -e "${GREEN}  3proxy + WARP (COMBINED)${NC}"
echo -e "${GREEN}============================================${NC}"

echo -e "\n${YELLOW}‚ö†Ô∏è  Script s·∫Ω:${NC}"
echo -e "${YELLOW}1. C√†i ƒë·∫∑t WARP ƒë·ªÉ che gi·∫•u VPS${NC}"
echo -e "${YELLOW}2. C√†i ƒë·∫∑t 3proxy v·ªõi IPv6${NC}"
echo -e "${YELLOW}3. K·∫øt n·ªëi 3proxy qua WARP${NC}"
echo -e "\n${BLUE}Nh·∫•n Enter ƒë·ªÉ ti·∫øp t·ª•c...${NC}"
read

# ================================================================
# H√ÄM TI·ªÜN √çCH (T·ª™ SCRIPT G·ªêC)
# ================================================================

random() {
    tr </dev/urandom -dc A-Za-z0-9 | head -c8
    echo
}

array=(1 2 3 4 5 6 7 8 9 0 a b c d e f)
gen64() {
    ip64() {
        echo "${array[$RANDOM % 16]}${array[$RANDOM % 16]}${array[$RANDOM % 16]}${array[$RANDOM % 16]}"
    }
    echo "$1:$(ip64):$(ip64):$(ip64):$(ip64)"
}

# ================================================================
# C√ÄI ƒê·∫∂T G√ìI (T·ª™ SCRIPT G·ªêC)
# ================================================================

echo "Installing required packages"
yum -y install gcc net-tools bsdtar zip curl expect >/dev/null

# ================================================================
# C√ÄI ƒê·∫∂T WARP (T·ª™ SCRIPT M·ªöI)
# ================================================================

install_cloudflare_warp() {
    echo -e "\n${YELLOW}Installing Cloudflare WARP...${NC}"
    
    if [ -f /etc/redhat-release ]; then
        curl -fsSL https://pkg.cloudflareclient.com/cloudflare-warp-ascii.repo | tee /etc/yum.repos.d/cloudflare-warp.repo >/dev/null
        yum install -y cloudflare-warp 2>&1 | tail -3
    else
        curl -fsSL https://pkg.cloudflareclient.com/pubkey.gpg | gpg --dearmor -o /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg
        echo "deb [arch=amd64 signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] https://pkg.cloudflareclient.com/ $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/cloudflare-client.list
        apt-get update -qq
        apt-get install -y cloudflare-warp 2>&1 | tail -3
    fi
    
    echo -e "${GREEN}‚úÖ WARP installed${NC}"
}

configure_cloudflare_warp() {
    echo -e "\n${YELLOW}Configuring Cloudflare WARP...${NC}"
    
    # Kh·ªüi ƒë·ªông service
    echo -e "${BLUE}Starting warp-svc...${NC}"
    systemctl enable warp-svc 2>/dev/null
    systemctl restart warp-svc
    sleep 5
    
    # X√≥a registration c≈©
    echo -e "${BLUE}Resetting WARP...${NC}"
    warp-cli disconnect 2>/dev/null
    warp-cli registration delete 2>/dev/null
    sleep 2
    
    # ƒêƒÉng k√Ω
    echo -e "${BLUE}Registering WARP...${NC}"
    cat > /tmp/warp-reg.exp <<'EXPECT'
#!/usr/bin/expect -f
set timeout 30
spawn warp-cli registration new
expect {
    "Accept*?" { send "y\r"; exp_continue }
    "y/N" { send "y\r"; exp_continue }
    "Success" { exit 0 }
    timeout { exit 1 }
    eof
}
EXPECT
    
    chmod +x /tmp/warp-reg.exp
    /tmp/warp-reg.exp 2>/dev/null || echo -e "y\ny\ny" | warp-cli registration new 2>/dev/null
    rm -f /tmp/warp-reg.exp
    sleep 3
    
    # ƒê·∫∑t ch·∫ø ƒë·ªô proxy
    echo -e "${BLUE}Setting proxy mode...${NC}"
    warp-cli mode proxy
    sleep 2
    
    # K·∫øt n·ªëi WARP
    echo -e "${BLUE}Connecting WARP (waiting 15 seconds)...${NC}"
    warp-cli connect
    sleep 15
    
    # Ki·ªÉm tra port 40000
    echo -e "${BLUE}Checking WARP proxy...${NC}"
    for i in {1..15}; do
        if netstat -tuln 2>/dev/null | grep -q ":40000" || ss -tuln 2>/dev/null | grep -q ":40000"; then
            echo -e "${GREEN}‚úÖ WARP Proxy is ready (port 40000)${NC}"
            
            # Test IP qua WARP
            WARP_IP=$(curl -x socks5://127.0.0.1:40000 -s --connect-timeout 10 https://api.ipify.org 2>/dev/null)
            if [ -n "$WARP_IP" ]; then
                echo -e "${GREEN}‚úÖ IP via WARP: ${WARP_IP}${NC}"
                WARP_WORKING=1
            fi
            
            return 0
        fi
        
        echo -e "${YELLOW}   Waiting for WARP proxy... ($i/15)${NC}"
        sleep 2
    done
    
    echo -e "${RED}‚ùå WARP proxy failed to start on port 40000${NC}"
    echo -e "${YELLOW}‚ö†Ô∏è  Proxy will work WITHOUT Cloudflare layer${NC}"
    WARP_WORKING=0
    return 1
}

# ================================================================
# C√ÄI ƒê·∫∂T 3PROXY (T·ª™ SCRIPT G·ªêC)
# ================================================================

install_3proxy() {
    echo "Installing 3proxy"
    URL="https://raw.githubusercontent.com/quayvlog/quayvlog/main/3proxy-3proxy-0.8.6.tar.gz"
    wget -qO- $URL | bsdtar -xvf-
    cd 3proxy-3proxy-0.8.6
    make -f Makefile.Linux
    mkdir -p /usr/local/etc/3proxy/{bin,logs,stat}
    cp src/3proxy /usr/local/etc/3proxy/bin/
    cd $WORKDIR
}

# ================================================================
# T·∫†O C·∫§U H√åNH 3PROXY
# ================================================================

gen_3proxy() {
    if [ "$WARP_WORKING" = "1" ]; then
        # C·∫•u h√¨nh C√ì WARP
        cat <<EOF
daemon
maxconn 2000
nscache 65535
timeouts 1 5 30 60 180 1800 15 60
setgid 65535
setuid 65535
flush

# Route qua WARP SOCKS5 Proxy
parent 1000 socks5 127.0.0.1 40000

auth strong

users $(awk -F "/" 'BEGIN{ORS="";} {print $1 ":CL:" $2 " "}' ${WORKDATA})

$(awk -F "/" '{print "auth strong\nallow " $1 "\nparent 1000\nproxy -6 -n -a -p" $4 " -i" $3 " -e"$5 "\nflush\n"}' ${WORKDATA})
EOF
    else
        # C·∫•u h√¨nh KH√îNG C√ì WARP (gi·ªëng script g·ªëc)
        cat <<EOF
daemon
maxconn 2000
nscache 65535
timeouts 1 5 30 60 180 1800 15 60
setgid 65535
setuid 65535
flush
auth strong

users $(awk -F "/" 'BEGIN{ORS="";} {print $1 ":CL:" $2 " "}' ${WORKDATA})

$(awk -F "/" '{print "auth strong\nallow " $1 "\nproxy -6 -n -a -p" $4 " -i" $3 " -e"$5 "\n"}' ${WORKDATA})
EOF
    fi
}

gen_proxy_file_for_user() {
    cat >proxy.txt <<EOF
$(awk -F "/" '{print $3 ":" $4 ":" $1 ":" $2 }' ${WORKDATA})
EOF
}

print_proxy() {
    echo "Proxy is ready! Format IP:PORT:LOGIN:PASS"
    echo "Here are your proxy details:"
    cat proxy.txt
}

gen_data() {
    seq $FIRST_PORT $LAST_PORT | while read port; do
        echo "usr$(random)/pass$(random)/$IP4/$port/$(gen64 $IP6)"
    done
}

gen_iptables() {
    cat <<EOF
$(awk -F "/" '{print "iptables -I INPUT -p tcp --dport " $4 " -m state --state NEW -j ACCEPT"}' ${WORKDATA})
EOF
}

gen_ifconfig() {
    cat <<EOF
$(awk -F "/" '{print "ip -6 addr add " $5 "/64 dev enp1s0"}' ${WORKDATA})
EOF
}

# ================================================================
# MAIN EXECUTION
# ================================================================

# C√†i ƒë·∫∑t WARP tr∆∞·ªõc
install_cloudflare_warp
configure_cloudflare_warp

# C√†i ƒë·∫∑t 3proxy
install_3proxy

echo "Working folder = /home/proxy-installer"
WORKDIR="/home/proxy-installer"
WORKDATA="${WORKDIR}/data.txt"
mkdir -p $WORKDIR && cd $_

IP4=$(curl -4 -s icanhazip.com)
IP6=$(curl -6 -s icanhazip.com | cut -f1-4 -d':')

echo "Internal IP = ${IP4}. External subnet for IPv6 = ${IP6}"

echo "How many proxies do you want to create? Example: 500"
read COUNT

FIRST_PORT=10000
LAST_PORT=$(($FIRST_PORT + $COUNT - 1))

# T·∫°o d·ªØ li·ªáu
gen_data >$WORKDIR/data.txt
gen_iptables >$WORKDIR/boot_iptables.sh
gen_ifconfig >$WORKDIR/boot_ifconfig.sh
chmod +x ${WORKDIR}/boot_*.sh

# T·∫°o c·∫•u h√¨nh 3proxy (t·ª± ƒë·ªông ch·ªçn c√≥/kh√¥ng WARP)
gen_3proxy >/usr/local/etc/3proxy/3proxy.cfg

echo "* soft nofile 65535" >> /etc/security/limits.conf
echo "* hard nofile 65535" >> /etc/security/limits.conf
echo "session required pam_limits.so" >> /etc/pam.d/common-session

# T·∫°o systemd service cho WARP
cat >/etc/systemd/system/cloudflare-warp-proxy.service <<EOF
[Unit]
Description=Cloudflare WARP Proxy Mode
Before=3proxy.service
After=network.target warp-svc.service
Requires=warp-svc.service

[Service]
Type=oneshot
ExecStart=/usr/bin/warp-cli mode proxy
ExecStartPost=/bin/sleep 3
ExecStartPost=/usr/bin/warp-cli connect
RemainAfterExit=yes
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# T·∫°o systemd service cho 3proxy
cat >/etc/systemd/system/3proxy.service <<EOF
[Unit]
Description=3proxy tiny proxy server
After=network.target cloudflare-warp-proxy.service
Wants=cloudflare-warp-proxy.service

[Service]
Type=forking
ExecStart=/usr/local/etc/3proxy/bin/3proxy /usr/local/etc/3proxy/3proxy.cfg
ExecStop=/bin/kill -TERM \$MAINPID
RemainAfterExit=yes
Restart=always
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable warp-svc 2>/dev/null
systemctl enable cloudflare-warp-proxy.service 2>/dev/null
systemctl enable 3proxy

# ================================================================
# QUAN TR·ªåNG: CH·∫†Y C√ÅC L·ªÜNH THI·∫æT L·∫¨P (T·ª™ SCRIPT G·ªêC)
# ================================================================

echo "Setting up iptables rules..."
bash ${WORKDIR}/boot_iptables.sh

echo "Setting up IPv6 interfaces..."
bash ${WORKDIR}/boot_ifconfig.sh

# Th√™m quy t·∫Øc t∆∞·ªùng l·ª≠a cho c√°c c·ªïng 3proxy
if command -v firewall-cmd >/dev/null 2>&1; then
    echo "Configuring firewall..."
    for port in $(seq $FIRST_PORT $LAST_PORT); do
        firewall-cmd --permanent --add-port=${port}/tcp 2>/dev/null
    done
    firewall-cmd --reload 2>/dev/null
fi

# T·∫°o file proxy
gen_proxy_file_for_user

# In th√¥ng tin proxy
print_proxy

# Kh·ªüi ƒë·ªông WARP proxy service
if [ "$WARP_WORKING" = "1" ]; then
    echo "Starting WARP proxy service..."
    systemctl start cloudflare-warp-proxy.service
    sleep 5
fi

# Kh·ªüi ƒë·ªông 3proxy
echo "Starting 3proxy..."
systemctl start 3proxy

echo "3proxy has been installed and configured. Check /usr/local/etc/3proxy/logs/3proxy.log for logs."
echo "You can check the status of 3proxy by running: systemctl status 3proxy"

if systemctl is-active --quiet 3proxy; then
    echo "3proxy is running."
else
    echo "3proxy failed to start. Check the logs with: journalctl -u 3proxy"
fi

echo "Contents of 3proxy configuration file:"
cat /usr/local/etc/3proxy/3proxy.cfg

echo "Listening ports:"
ss -tuln | grep 3proxy

if command -v firewall-cmd >/dev/null 2>&1; then
    echo "Firewall status:"
    firewall-cmd --list-all
fi

# Th√™m ki·ªÉm tra v√† kh·ªüi ƒë·ªông l·∫°i n·∫øu c·∫ßn
if ! pgrep -x "3proxy" > /dev/null; then
    echo "3proxy is not running. Attempting to start..."
    systemctl start 3proxy
    sleep 5
    if pgrep -x "3proxy" > /dev/null; then
        echo "3proxy has been successfully started."
    else
        echo "Failed to start 3proxy. Please check the logs."
    fi
fi

# Ki·ªÉm tra k·∫øt n·ªëi
echo "Testing proxy connections..."
for port in $(seq $FIRST_PORT $((FIRST_PORT + 4))); do
    if nc -z localhost $port; then
        echo "Port $port is open and accessible"
    else
        echo "Port $port is not accessible"
    fi
done

# ================================================================
# KI·ªÇM TRA CU·ªêI C√ôNG
# ================================================================

echo ""
echo "============================================"
echo "  FINAL CHECK"
echo "============================================"

# Ki·ªÉm tra WARP
echo ""
echo "[1] WARP Status:"
if netstat -tuln 2>/dev/null | grep -q ":40000" || ss -tuln 2>/dev/null | grep -q ":40000"; then
    echo "‚úÖ WARP Proxy: WORKING (port 40000)"
    
    WARP_TEST_IP=$(curl -x socks5://127.0.0.1:40000 -s --connect-timeout 10 https://api.ipify.org 2>/dev/null)
    if [ -n "$WARP_TEST_IP" ]; then
        echo "   IP via WARP: ${WARP_TEST_IP}"
    fi
else
    echo "‚ùå WARP Proxy: NOT WORKING"
    echo "   Proxy will work WITHOUT Cloudflare layer"
fi

# Ki·ªÉm tra 3proxy
echo ""
echo "[2] 3proxy Status:"
if systemctl is-active --quiet 3proxy; then
    echo "‚úÖ 3proxy: Running"
else
    echo "‚ùå 3proxy: Not running"
fi

# Test proxy th·ª±c t·∫ø
echo ""
echo "[3] Testing actual proxy..."
TEST_PROXY=$(head -1 proxy.txt)
echo "Proxy: ${TEST_PROXY}"

# Th·ª≠ 5 l·∫ßn
PROXY_WORKS=0
for i in {1..5}; do
    TEST_RESULT=$(timeout 20 curl -x socks5://${TEST_PROXY} -s https://api.ipify.org 2>/dev/null)
    
    if [ -n "$TEST_RESULT" ]; then
        echo "‚úÖ Attempt $i: IP = ${TEST_RESULT}"
        
        if [ "$TEST_RESULT" != "$IP4" ]; then
            echo "   üéâ IP differs from VPS ‚Üí Traffic going through Cloudflare!"
        else
            echo "   ‚ÑπÔ∏è  IP = VPS ‚Üí Proxy working but not via Cloudflare"
        fi
        
        PROXY_WORKS=1
        break
    else
        if [ $i -lt 5 ]; then
            echo "‚è≥ Attempt $i timeout, retrying..."
            sleep 5
        else
            echo "‚ùå Timeout after 5 attempts"
        fi
    fi
done

# ================================================================
# K·∫æT LU·∫¨N
# ================================================================

echo ""
echo "============================================"
echo "  RESULT"
echo "============================================"

if [ $PROXY_WORKS -eq 1 ]; then
    echo "‚úÖ SUCCESS! Proxy is working"
    echo "   Proxy file: ${WORKDIR}/proxy.txt"
    
    if [ "$WARP_WORKING" = "1" ]; then
        echo "   Traffic routed through Cloudflare WARP"
    else
        echo "   Proxy working WITHOUT WARP layer"
    fi
else
    echo "‚ö†Ô∏è  ISSUE! Proxy test failed"
    echo ""
    echo "TROUBLESHOOTING:"
    echo "1. Check logs:"
    echo "   journalctl -u 3proxy -n 100"
    echo "   cat /usr/local/etc/3proxy/logs/3proxy.log"
    echo ""
    echo "2. Check IPv6 interfaces:"
    echo "   ip -6 addr show | grep ${IP6}"
    echo ""
    echo "3. Restart services:"
    echo "   systemctl restart 3proxy"
    echo "   systemctl restart warp-svc"
    echo "   warp-cli connect"
fi

# L∆∞u h∆∞·ªõng d·∫´n
cat > ${WORKDIR}/GUIDE.txt <<EOF
============================================
  PROXY USAGE GUIDE
============================================

PROXY FILE: ${WORKDIR}/proxy.txt
QUANTITY: ${COUNT} proxies
PORTS: ${FIRST_PORT} - ${LAST_PORT}
FORMAT: IP:PORT:USER:PASS

ARCHITECTURE:
  Client ‚Üí 3proxy (${IP4}:${FIRST_PORT}+)
         ‚Üí IPv6 (${IP6}:xxxx)
         $([ "$WARP_WORKING" = "1" ] && echo "‚Üí WARP Proxy (127.0.0.1:40000)" || echo "")
         $([ "$WARP_WORKING" = "1" ] && echo "‚Üí Cloudflare" || echo "")
         ‚Üí Internet

CHECK STATUS:

1. Services status:
   systemctl status 3proxy
   systemctl status warp-svc

2. Test proxy:
   curl -x socks5://${TEST_PROXY} https://api.ipify.org
   (IP should differ from ${IP4} if WARP is active)

3. Check logs:
   journalctl -u 3proxy -f
   cat /usr/local/etc/3proxy/logs/3proxy.log

4. Check listening ports:
   ss -tuln | grep ${FIRST_PORT}
   netstat -tuln | grep ${FIRST_PORT}

5. Check IPv6:
   ip -6 addr show | grep ${IP6}

TROUBLESHOOTING:

A. If WARP not working:
   systemctl restart warp-svc
   sleep 5
   warp-cli registration delete
   warp-cli registration new
   warp-cli mode proxy
   warp-cli connect
   sleep 10
   netstat -tuln | grep 40000

B. If 3proxy not working:
   systemctl stop 3proxy
   /usr/local/etc/3proxy/bin/3proxy /usr/local/etc/3proxy/3proxy.cfg
   (See errors directly)

C. If IPv6 not working:
   bash ${WORKDIR}/boot_ifconfig.sh
   ip -6 addr show

D. If firewall blocking:
   bash ${WORKDIR}/boot_iptables.sh
   firewall-cmd --list-all
   iptables -L -n | grep ${FIRST_PORT}

AFTER REBOOT:
   systemctl start warp-svc
   warp-cli connect
   systemctl start 3proxy
   (IPv6 interfaces should auto-restore via boot_ifconfig.sh)

============================================
EOF

echo ""
echo "üìñ Full guide: ${WORKDIR}/GUIDE.txt"
echo "‚úÖ Script completed!"
echo ""

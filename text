#!/bin/bash
# ================================================================

# Kiểm tra nếu script chạy với quyền root
if [ "$(id -u)" != "0" ]; then
    echo "❌ This script must be run as root" 1>&2
    echo "Run: sudo bash script.sh"
    exit 1
fi

# Màu sắc cho output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${GREEN}============================================${NC}"
echo -e "${GREEN}  3proxy + Cloudflare WARP Setup${NC}"
echo -e "${GREEN}============================================${NC}"

# ================================================================
# PHẦN 1: CÀI ĐẶT CLOUDFLARE WARP (THÊM MỚI)
# ================================================================

install_cloudflare_warp() {
    echo -e "\n${YELLOW}[BƯỚC 1/8] Cài đặt Cloudflare WARP...${NC}"
    
    # Phát hiện hệ điều hành
    if [ -f /etc/redhat-release ]; then
        # CentOS/RHEL/Rocky Linux
        echo -e "${BLUE}Phát hiện: CentOS/RHEL${NC}"
        
        # Thêm Cloudflare repository
        curl -fsSL https://pkg.cloudflareclient.com/cloudflare-warp-ascii.repo | tee /etc/yum.repos.d/cloudflare-warp.repo >/dev/null
        
        # Cài đặt WARP
        yum install -y cloudflare-warp >/dev/null 2>&1
        
    elif [ -f /etc/debian_version ]; then
        # Debian/Ubuntu
        echo -e "${BLUE}Phát hiện: Debian/Ubuntu${NC}"
        
        # Thêm GPG key
        curl -fsSL https://pkg.cloudflareclient.com/pubkey.gpg | gpg --dearmor -o /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg
        
        # Thêm repository
        echo "deb [arch=amd64 signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] https://pkg.cloudflareclient.com/ $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/cloudflare-client.list
        
        apt-get update -qq
        apt-get install -y cloudflare-warp >/dev/null 2>&1
    else
        echo -e "${RED}❌ Hệ điều hành không được hỗ trợ${NC}"
        exit 1
    fi
    
    echo -e "${GREEN}✅ Đã cài đặt Cloudflare WARP${NC}"
}

configure_cloudflare_warp() {
    echo -e "\n${YELLOW}[BƯỚC 2/8] Cấu hình Cloudflare WARP...${NC}"
    
    # Đăng ký WARP
    warp-cli registration delete >/dev/null 2>&1
    warp-cli register >/dev/null 2>&1
    
    # Đặt chế độ WARP (không phải WARP+)
    warp-cli set-mode warp >/dev/null 2>&1
    
    # Kết nối
    warp-cli connect >/dev/null 2>&1
    sleep 5
    
    # Kiểm tra kết nối
    if warp-cli status | grep -q "Connected"; then
        echo -e "${GREEN}✅ Cloudflare WARP đã kết nối${NC}"
        
        # Hiển thị IP sau khi kết nối WARP
        WARP_IP4=$(curl --interface CloudflareWARP -4 -s icanhazip.com 2>/dev/null || echo "N/A")
        WARP_IP6=$(curl --interface CloudflareWARP -6 -s icanhazip.com 2>/dev/null || echo "N/A")
        
        echo -e "${BLUE}IP qua Cloudflare:${NC}"
        echo -e "  IPv4: ${GREEN}${WARP_IP4}${NC}"
        echo -e "  IPv6: ${GREEN}${WARP_IP6}${NC}"
    else
        echo -e "${RED}❌ Không thể kết nối WARP${NC}"
        echo -e "${YELLOW}Đang thử kết nối lại...${NC}"
        warp-cli disconnect >/dev/null 2>&1
        sleep 2
        warp-cli connect >/dev/null 2>&1
        sleep 5
        
        if ! warp-cli status | grep -q "Connected"; then
            echo -e "${RED}❌ WARP vẫn không kết nối được${NC}"
            echo -e "${YELLOW}Script sẽ tiếp tục nhưng proxy có thể không hoạt động qua Cloudflare${NC}"
        fi
    fi
}

# ================================================================
# PHẦN 2: CÁC HÀM GỐC CỦA BẠN (GIỮ NGUYÊN)
# ================================================================

random() {
    tr </dev/urandom -dc A-Za-z0-9 | head -c8
    echo
}

array=(1 2 3 4 5 6 7 8 9 0 a b c d e f)
gen64() {
    ip64() {
        echo "${array[$RANDOM % 16]}${array[$RANDOM % 16]}${array[$RANDOM % 16]}${array[$RANDOM % 16]}"
    }
    echo "$1:$(ip64):$(ip64):$(ip64):$(ip64)"
}

install_3proxy() {
    echo -e "\n${YELLOW}[BƯỚC 3/8] Cài đặt 3proxy...${NC}"
    URL="https://raw.githubusercontent.com/quayvlog/quayvlog/main/3proxy-3proxy-0.8.6.tar.gz"
    wget -qO- $URL | bsdtar -xvf-
    cd 3proxy-3proxy-0.8.6
    make -f Makefile.Linux
    mkdir -p /usr/local/etc/3proxy/{bin,logs,stat}
    cp src/3proxy /usr/local/etc/3proxy/bin/
    cd $WORKDIR
    echo -e "${GREEN}✅ Đã cài đặt 3proxy${NC}"
}

# ================================================================
# PHẦN 3: CẤU HÌNH 3PROXY VỚI WARP (SỬA ĐỔI)
# ================================================================

gen_3proxy() {
    cat <<EOF
daemon
maxconn 2000
nscache 65535
timeouts 1 5 30 60 180 1800 15 60
setgid 65535
setuid 65535
flush

# ============================================
# THÊM MỚI: Cấu hình routing qua Cloudflare WARP
# ============================================
# Cloudflare WARP interface
# parent 1000 socks5 127.0.0.1 40000

auth strong

users $(awk -F "/" 'BEGIN{ORS="";} {print $1 ":CL:" $2 " "}' ${WORKDATA})

$(awk -F "/" '{print "auth strong\nallow " $1 "\n# Route qua CloudflareWARP interface\nproxy -6 -n -a -p" $4 " -i" $3 " -e"$5 "\nflush\n"}' ${WORKDATA})
EOF
}

gen_proxy_file_for_user() {
    cat >proxy.txt <<EOF
$(awk -F "/" '{print $3 ":" $4 ":" $1 ":" $2 }' ${WORKDATA})
EOF
}

print_proxy() {
    echo -e "\n${GREEN}============================================${NC}"
    echo -e "${GREEN}  PROXY ĐÃ SẴN SÀNG!${NC}"
    echo -e "${GREEN}============================================${NC}"
    echo -e "${BLUE}Format: IP:PORT:USERNAME:PASSWORD${NC}"
    echo -e "\n${YELLOW}Tất cả proxy đều được bảo vệ bởi Cloudflare WARP${NC}"
    echo -e "${YELLOW}File proxy đã lưu tại: ${WORKDIR}/proxy.txt${NC}\n"
    head -10 proxy.txt
    echo -e "\n${BLUE}... (xem file proxy.txt để biết đầy đủ)${NC}"
}

gen_data() {
    seq $FIRST_PORT $LAST_PORT | while read port; do
        echo "usr$(random)/pass$(random)/$IP4/$port/$(gen64 $IP6)"
    done
}

gen_iptables() {
    cat <<EOF
$(awk -F "/" '{print "iptables -I INPUT -p tcp --dport " $4 " -m state --state NEW -j ACCEPT"}' ${WORKDATA})
EOF
}

gen_ifconfig() {
    cat <<EOF
$(awk -F "/" '{print "ip -6 addr add " $5 "/64 dev enp1s0"}' ${WORKDATA})
EOF
}

# ================================================================
# PHẦN 4: CẤU HÌNH ROUTING QUA WARP (THÊM MỚI)
# ================================================================

configure_warp_routing() {
    echo -e "\n${YELLOW}[BƯỚC 6/8] Cấu hình routing qua Cloudflare WARP...${NC}"
    
    # Tạo routing table cho WARP
    if ! grep -q "100 warp" /etc/iproute2/rt_tables; then
        echo "100 warp" >> /etc/iproute2/rt_tables
    fi
    
    # Lấy interface CloudflareWARP
    WARP_INTERFACE=$(ip -o link show | grep -i cloudflare | awk -F': ' '{print $2}' | head -1)
    
    if [ -n "$WARP_INTERFACE" ]; then
        echo -e "${BLUE}Cloudflare interface: ${WARP_INTERFACE}${NC}"
        
        # Thêm route cho IPv6 qua WARP
        ip -6 route add default dev $WARP_INTERFACE table warp 2>/dev/null
        
        # Thêm rule cho IPv6 từ proxy
        ip -6 rule add from ${IP6}::/64 table warp 2>/dev/null
        
        echo -e "${GREEN}✅ Đã cấu hình routing qua WARP${NC}"
    else
        echo -e "${YELLOW}⚠️  Không tìm thấy CloudflareWARP interface${NC}"
        echo -e "${YELLOW}    Proxy sẽ vẫn hoạt động nhưng có thể không qua WARP${NC}"
    fi
    
    # Tạo script tự động khởi động WARP routing
    cat > /usr/local/bin/setup-warp-routing.sh <<'SCRIPT'
#!/bin/bash
# Script tự động cấu hình routing qua WARP

# Đợi WARP kết nối
for i in {1..30}; do
    if warp-cli status | grep -q "Connected"; then
        break
    fi
    sleep 1
done

# Lấy interface
WARP_INTERFACE=$(ip -o link show | grep -i cloudflare | awk -F': ' '{print $2}' | head -1)

if [ -n "$WARP_INTERFACE" ]; then
    # Lấy IPv6 subnet
    IP6=$(curl -6 -s icanhazip.com | cut -f1-4 -d':')
    
    # Setup routing
    ip -6 route add default dev $WARP_INTERFACE table warp 2>/dev/null
    ip -6 rule add from ${IP6}::/64 table warp 2>/dev/null
    
    echo "WARP routing configured successfully"
else
    echo "CloudflareWARP interface not found"
fi
SCRIPT
    
    chmod +x /usr/local/bin/setup-warp-routing.sh
}

# ================================================================
# PHẦN 5: TẠO SERVICE TỰ ĐỘNG KHỞI ĐỘNG (THÊM MỚI)
# ================================================================

create_warp_service() {
    echo -e "\n${YELLOW}[BƯỚC 7/8] Tạo systemd service cho WARP...${NC}"
    
    # Service khởi động WARP trước 3proxy
    cat >/etc/systemd/system/cloudflare-warp-autoconnect.service <<EOF
[Unit]
Description=Cloudflare WARP Auto-connect
Before=3proxy.service
After=network.target

[Service]
Type=oneshot
ExecStart=/usr/bin/warp-cli connect
ExecStartPost=/bin/sleep 5
ExecStartPost=/usr/local/bin/setup-warp-routing.sh
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF

    systemctl daemon-reload
    systemctl enable cloudflare-warp-autoconnect.service
    
    echo -e "${GREEN}✅ Đã tạo WARP auto-connect service${NC}"
}

# ================================================================
# PHẦN 6: MAIN EXECUTION
# ================================================================

echo -e "\n${YELLOW}[BƯỚC 0/8] Cài đặt các gói cần thiết...${NC}"
yum -y install gcc net-tools bsdtar zip curl >/dev/null 2>&1

# Cài đặt Cloudflare WARP
install_cloudflare_warp
configure_cloudflare_warp

# Cài đặt 3proxy
install_3proxy

echo -e "\n${YELLOW}[BƯỚC 4/8] Thiết lập thư mục làm việc...${NC}"
WORKDIR="/home/proxy-installer"
WORKDATA="${WORKDIR}/data.txt"
mkdir -p $WORKDIR && cd $_

IP4=$(curl -4 -s icanhazip.com)
IP6=$(curl -6 -s icanhazip.com | cut -f1-4 -d':')

echo -e "${BLUE}IP VPS của bạn:${NC}"
echo -e "  IPv4: ${GREEN}${IP4}${NC}"
echo -e "  IPv6 Subnet: ${GREEN}${IP6}${NC}"

echo -e "\n${YELLOW}Bạn muốn tạo bao nhiêu proxy? (Ví dụ: 500)${NC}"
read COUNT

FIRST_PORT=10000
LAST_PORT=$(($FIRST_PORT + $COUNT - 1))

echo -e "\n${YELLOW}[BƯỚC 5/8] Tạo dữ liệu proxy...${NC}"
gen_data >$WORKDIR/data.txt
gen_iptables >$WORKDIR/boot_iptables.sh
gen_ifconfig >$WORKDIR/boot_ifconfig.sh
chmod +x ${WORKDIR}/boot_*.sh

gen_3proxy >/usr/local/etc/3proxy/3proxy.cfg

# Cấu hình hệ thống
echo "* soft nofile 65535" >> /etc/security/limits.conf
echo "* hard nofile 65535" >> /etc/security/limits.conf

# Tạo 3proxy service (SỬA ĐỔI: thêm dependency vào WARP)
cat >/etc/systemd/system/3proxy.service <<EOF
[Unit]
Description=3proxy tiny proxy server
After=network.target cloudflare-warp-autoconnect.service
Wants=cloudflare-warp-autoconnect.service

[Service]
Type=forking
ExecStart=/usr/local/etc/3proxy/bin/3proxy /usr/local/etc/3proxy/3proxy.cfg
ExecStop=/bin/kill -TERM \$MAINPID
RemainAfterExit=yes
Restart=always
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable 3proxy

# Cấu hình routing và services
configure_warp_routing
create_warp_service

# Khởi động services
echo -e "\n${YELLOW}[BƯỚC 8/8] Khởi động các dịch vụ...${NC}"

# Khởi động WARP service
systemctl start cloudflare-warp-autoconnect.service
sleep 3

# Chạy network setup
bash ${WORKDIR}/boot_iptables.sh
bash ${WORKDIR}/boot_ifconfig.sh

# Cấu hình firewall
for port in $(seq $FIRST_PORT $LAST_PORT); do
    firewall-cmd --permanent --add-port=${port}/tcp 2>/dev/null
done
firewall-cmd --reload 2>/dev/null

# Tạo file proxy
gen_proxy_file_for_user

# Khởi động 3proxy
systemctl start 3proxy

# Hiển thị kết quả
print_proxy

# ================================================================
# PHẦN 7: KIỂM TRA VÀ XÁC NHẬN
# ================================================================

echo -e "\n${YELLOW}============================================${NC}"
echo -e "${YELLOW}  KIỂM TRA TRẠNG THÁI${NC}"
echo -e "${YELLOW}============================================${NC}"

# Kiểm tra WARP
if warp-cli status | grep -q "Connected"; then
    echo -e "${GREEN}✅ Cloudflare WARP: Đang hoạt động${NC}"
else
    echo -e "${RED}❌ Cloudflare WARP: Không kết nối${NC}"
fi

# Kiểm tra 3proxy
if systemctl is-active --quiet 3proxy; then
    echo -e "${GREEN}✅ 3proxy: Đang chạy${NC}"
else
    echo -e "${RED}❌ 3proxy: Không hoạt động${NC}"
    echo -e "${YELLOW}Kiểm tra log: journalctl -u 3proxy${NC}"
fi

# Kiểm tra ports
echo -e "\n${BLUE}Kiểm tra một vài port mẫu...${NC}"
for port in $(seq $FIRST_PORT $(($FIRST_PORT + 2))); do
    if nc -z localhost $port 2>/dev/null; then
        echo -e "${GREEN}✅ Port $port: Đang mở${NC}"
    else
        echo -e "${RED}❌ Port $port: Không truy cập được${NC}"
    fi
done

# Hướng dẫn test
echo -e "\n${YELLOW}============================================${NC}"
echo -e "${YELLOW}  HƯỚNG DẪN TEST PROXY${NC}"
echo -e "${YELLOW}============================================${NC}"

FIRST_PROXY=$(head -1 proxy.txt)
echo -e "${BLUE}Proxy đầu tiên: ${GREEN}${FIRST_PROXY}${NC}"
echo -e "\n${YELLOW}Test bằng curl (trên VPS):${NC}"
echo -e "${BLUE}curl -x socks5://${FIRST_PROXY} https://api.ipify.org${NC}"
echo -e "\n${YELLOW}Kết quả mong đợi:${NC}"
echo -e "  - Sẽ hiển thị IP của Cloudflare (KHÔNG phải IP VPS của bạn)"
echo -e "  - IP này sẽ thay đổi theo thời gian"

echo -e "\n${GREEN}============================================${NC}"
echo -e "${GREEN}  HOÀN TẤT CÀI ĐẶT!${NC}"
echo -e "${GREEN}============================================${NC}"
echo -e "${YELLOW}File proxy: ${WORKDIR}/proxy.txt${NC}"
echo -e "${YELLOW}Logs: journalctl -u 3proxy -f${NC}"
echo -e "${YELLOW}WARP status: warp-cli status${NC}"

# Lưu thông tin cấu hình
cat > ${WORKDIR}/README.txt <<EOF
================================================
  3PROXY + CLOUDFLARE WARP CONFIGURATION
================================================

Số lượng proxy: ${COUNT}
Port range: ${FIRST_PORT}-${LAST_PORT}
File proxy: ${WORKDIR}/proxy.txt

VPS IP:
  IPv4: ${IP4}
  IPv6: ${IP6}

Cloudflare WARP Status:
  $(warp-cli status)

Commands:
  - Xem log 3proxy: journalctl -u 3proxy -f
  - Xem log WARP: journalctl -u cloudflare-warp-autoconnect -f
  - Kiểm tra WARP: warp-cli status
  - Kết nối lại WARP: warp-cli connect
  - Restart 3proxy: systemctl restart 3proxy
  - Test proxy: curl -x socks5://USER:PASS@${IP4}:${FIRST_PORT} https://api.ipify.org

Lưu ý:
  - Tất cả IPv6 proxy đều được route qua Cloudflare WARP
  - IP hiển thị sẽ là IP của Cloudflare, không phải VPS
  - IPv6 sẽ tự động rotating qua Cloudflare
  - Nếu WARP disconnect, chạy: systemctl restart cloudflare-warp-autoconnect

================================================
EOF

echo -e "\n${BLUE}Thông tin chi tiết đã lưu tại: ${WORKDIR}/README.txt${NC}"

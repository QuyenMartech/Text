#!/bin/bash
# ================================================================
# Script: 3proxy + Cloudflare WARP (SSH-SAFE v4.1)
# Version: 4.1 - Fixed installation hang issue
# ================================================================

if [ "$(id -u)" != "0" ]; then
    echo "❌ Script phải chạy với quyền root"
    exit 1
fi

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${GREEN}============================================${NC}"
echo -e "${GREEN}  3proxy + WARP v4.1 (SSH-Safe)${NC}"
echo -e "${GREEN}============================================${NC}"

echo -e "\n${YELLOW}⚠️  LƯU Ý:${NC}"
echo -e "${YELLOW}WARP sẽ chạy ở chế độ PROXY (an toàn SSH)${NC}"
echo -e "\n${BLUE}Nhấn Enter để tiếp tục (hoặc Ctrl+C để hủy)${NC}"
read

# ================================================================
# PHẦN 0: CÀI ĐẶT GÓI (ĐÃ SỬA)
# ================================================================

install_packages() {
    echo -e "\n${YELLOW}[0/8] Cài đặt gói cần thiết...${NC}"
    
    if [ -f /etc/redhat-release ]; then
        echo -e "${BLUE}Đang cài: gcc net-tools bsdtar zip curl expect...${NC}"
        
        # Cài từng gói để dễ debug
        yum install -y gcc 2>&1 | grep -v "^Loaded plugins" | tail -3
        yum install -y net-tools 2>&1 | grep -v "^Loaded plugins" | tail -3
        yum install -y bsdtar 2>&1 | grep -v "^Loaded plugins" | tail -3
        yum install -y zip 2>&1 | grep -v "^Loaded plugins" | tail -3
        yum install -y curl 2>&1 | grep -v "^Loaded plugins" | tail -3
        yum install -y expect 2>&1 | grep -v "^Loaded plugins" | tail -3
        
    elif [ -f /etc/debian_version ]; then
        echo -e "${BLUE}Đang cài: gcc net-tools bsdtar zip curl expect...${NC}"
        
        apt-get update -qq 2>&1 | tail -3
        apt-get install -y gcc net-tools bsdtar zip curl expect 2>&1 | grep -v "^Reading" | tail -5
    else
        echo -e "${RED}❌ Hệ điều hành không hỗ trợ${NC}"
        exit 1
    fi
    
    echo -e "${GREEN}✅ Đã cài đặt gói${NC}"
}

# ================================================================
# PHẦN 1: CÀI ĐẶT WARP
# ================================================================

install_cloudflare_warp() {
    echo -e "\n${YELLOW}[1/8] Cài đặt Cloudflare WARP...${NC}"
    
    if [ -f /etc/redhat-release ]; then
        echo -e "${BLUE}CentOS/RHEL${NC}"
        
        echo -e "${BLUE}Thêm Cloudflare repo...${NC}"
        curl -fsSL https://pkg.cloudflareclient.com/cloudflare-warp-ascii.repo | tee /etc/yum.repos.d/cloudflare-warp.repo
        
        echo -e "${BLUE}Cài đặt cloudflare-warp...${NC}"
        yum install -y cloudflare-warp 2>&1 | grep -v "^Loaded plugins" | tail -5
        
    elif [ -f /etc/debian_version ]; then
        echo -e "${BLUE}Debian/Ubuntu${NC}"
        
        echo -e "${BLUE}Thêm GPG key...${NC}"
        curl -fsSL https://pkg.cloudflareclient.com/pubkey.gpg | gpg --dearmor -o /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg
        
        echo -e "${BLUE}Thêm repo...${NC}"
        echo "deb [arch=amd64 signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] https://pkg.cloudflareclient.com/ $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/cloudflare-client.list
        
        echo -e "${BLUE}Cài đặt...${NC}"
        apt-get update -qq
        apt-get install -y cloudflare-warp 2>&1 | tail -5
    fi
    
    echo -e "${GREEN}✅ Đã cài đặt WARP${NC}"
}

configure_cloudflare_warp() {
    echo -e "\n${YELLOW}[2/8] Cấu hình WARP (Proxy Mode)...${NC}"
    
    echo -e "${BLUE}Khởi động warp-svc...${NC}"
    systemctl enable warp-svc 2>/dev/null
    systemctl restart warp-svc
    sleep 5
    
    echo -e "${BLUE}Xóa registration cũ...${NC}"
    warp-cli registration delete 2>/dev/null
    sleep 2
    
    echo -e "${BLUE}Đăng ký WARP...${NC}"
    
    # Tạo expect script
    cat > /tmp/warp-reg.exp <<'EXPECT'
#!/usr/bin/expect -f
set timeout 30
spawn warp-cli registration new
expect {
    "Accept*?" { send "y\r"; exp_continue }
    "y/N" { send "y\r"; exp_continue }
    "Success" { exit 0 }
    timeout { exit 1 }
    eof
}
EXPECT
    
    chmod +x /tmp/warp-reg.exp
    
    if command -v expect >/dev/null 2>&1; then
        /tmp/warp-reg.exp
    else
        echo -e "y\ny\ny" | warp-cli registration new
    fi
    
    rm -f /tmp/warp-reg.exp
    sleep 3
    
    # Kiểm tra registration
    REG_STATUS=$(warp-cli registration show 2>&1)
    if echo "$REG_STATUS" | grep -qi "Created\|Device ID"; then
        echo -e "${GREEN}✅ Đăng ký thành công${NC}"
    else
        echo -e "${YELLOW}⚠️  Đăng ký có thể chưa hoàn tất${NC}"
    fi
    
    # Đặt chế độ proxy
    echo -e "${BLUE}Đặt chế độ PROXY...${NC}"
    warp-cli mode proxy
    sleep 2
    
    echo -e "${GREEN}✅ WARP Proxy sẵn sàng (port 40000)${NC}"
}

# ================================================================
# PHẦN 2: HÀM GỐC
# ================================================================

random() {
    tr </dev/urandom -dc A-Za-z0-9 | head -c8
    echo
}

array=(1 2 3 4 5 6 7 8 9 0 a b c d e f)
gen64() {
    ip64() {
        echo "${array[$RANDOM % 16]}${array[$RANDOM % 16]}${array[$RANDOM % 16]}${array[$RANDOM % 16]}"
    }
    echo "$1:$(ip64):$(ip64):$(ip64):$(ip64)"
}

install_3proxy() {
    echo -e "\n${YELLOW}[3/8] Cài đặt 3proxy...${NC}"
    
    URL="https://raw.githubusercontent.com/quayvlog/quayvlog/main/3proxy-3proxy-0.8.6.tar.gz"
    
    echo -e "${BLUE}Download 3proxy...${NC}"
    wget -qO- $URL | bsdtar -xvf- 2>&1 | head -5
    
    if [ ! -d "3proxy-3proxy-0.8.6" ]; then
        echo -e "${RED}❌ Download thất bại${NC}"
        exit 1
    fi
    
    cd 3proxy-3proxy-0.8.6
    
    echo -e "${BLUE}Compile 3proxy...${NC}"
    make -f Makefile.Linux 2>&1 | tail -3
    
    mkdir -p /usr/local/etc/3proxy/{bin,logs,stat}
    cp src/3proxy /usr/local/etc/3proxy/bin/
    
    cd $WORKDIR
    echo -e "${GREEN}✅ Đã cài đặt 3proxy${NC}"
}

gen_3proxy() {
    cat <<EOF
daemon
maxconn 2000
nscache 65535
timeouts 1 5 30 60 180 1800 15 60
setgid 65535
setuid 65535
flush

# Route qua WARP SOCKS5 Proxy (127.0.0.1:40000)
parent 1000 socks5 127.0.0.1 40000

auth strong

users $(awk -F "/" 'BEGIN{ORS="";} {print $1 ":CL:" $2 " "}' ${WORKDATA})

$(awk -F "/" '{print "auth strong\nallow " $1 "\nparent 1000\nproxy -6 -n -a -p" $4 " -i" $3 " -e"$5 "\nflush\n"}' ${WORKDATA})
EOF
}

gen_proxy_file_for_user() {
    cat >proxy.txt <<EOF
$(awk -F "/" '{print $3 ":" $4 ":" $1 ":" $2 }' ${WORKDATA})
EOF
}

print_proxy() {
    echo -e "\n${GREEN}============================================${NC}"
    echo -e "${GREEN}  ✅ PROXY SẴN SÀNG!${NC}"
    echo -e "${GREEN}============================================${NC}"
    echo -e "${BLUE}Format: IP:PORT:USER:PASS${NC}"
    echo -e "${YELLOW}File: ${WORKDIR}/proxy.txt${NC}\n"
    head -10 proxy.txt
    TOTAL=$(wc -l < proxy.txt)
    if [ $TOTAL -gt 10 ]; then
        echo -e "\n${BLUE}... và $((TOTAL - 10)) proxy khác${NC}"
    fi
}

gen_data() {
    seq $FIRST_PORT $LAST_PORT | while read port; do
        echo "usr$(random)/pass$(random)/$IP4/$port/$(gen64 $IP6)"
    done
}

gen_iptables() {
    cat <<EOF
$(awk -F "/" '{print "iptables -I INPUT -p tcp --dport " $4 " -m state --state NEW -j ACCEPT"}' ${WORKDATA})
EOF
}

gen_ifconfig() {
    cat <<EOF
$(awk -F "/" '{print "ip -6 addr add " $5 "/64 dev enp1s0"}' ${WORKDATA})
EOF
}

create_warp_service() {
    echo -e "\n${YELLOW}[6/8] Tạo service...${NC}"
    
    cat >/etc/systemd/system/cloudflare-warp-proxy.service <<EOF
[Unit]
Description=Cloudflare WARP Proxy Mode
Before=3proxy.service
After=network.target warp-svc.service
Requires=warp-svc.service

[Service]
Type=oneshot
ExecStart=/usr/bin/warp-cli mode proxy
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF

    systemctl daemon-reload
    systemctl enable warp-svc 2>/dev/null
    systemctl enable cloudflare-warp-proxy.service 2>/dev/null
    
    echo -e "${GREEN}✅ Service đã tạo${NC}"
}

# ================================================================
# MAIN EXECUTION
# ================================================================

install_packages

install_cloudflare_warp
configure_cloudflare_warp

install_3proxy

echo -e "\n${YELLOW}[4/8] Thiết lập...${NC}"
WORKDIR="/home/proxy-installer"
WORKDATA="${WORKDIR}/data.txt"
mkdir -p $WORKDIR && cd $_

IP4=$(curl -4 -s icanhazip.com)
IP6=$(curl -6 -s icanhazip.com | cut -f1-4 -d':')

echo -e "${BLUE}VPS:${NC}"
echo -e "  IPv4: ${GREEN}${IP4}${NC}"
echo -e "  IPv6: ${GREEN}${IP6}${NC}"

echo -e "\n${YELLOW}Số lượng proxy (ví dụ: 100):${NC}"
read COUNT

FIRST_PORT=10000
LAST_PORT=$(($FIRST_PORT + $COUNT - 1))

echo -e "\n${YELLOW}[5/8] Tạo cấu hình...${NC}"
gen_data >$WORKDIR/data.txt
gen_iptables >$WORKDIR/boot_iptables.sh
gen_ifconfig >$WORKDIR/boot_ifconfig.sh
chmod +x ${WORKDIR}/boot_*.sh

gen_3proxy >/usr/local/etc/3proxy/3proxy.cfg

echo "* soft nofile 65535" >> /etc/security/limits.conf
echo "* hard nofile 65535" >> /etc/security/limits.conf

cat >/etc/systemd/system/3proxy.service <<EOF
[Unit]
Description=3proxy tiny proxy server
After=network.target cloudflare-warp-proxy.service
Wants=cloudflare-warp-proxy.service

[Service]
Type=forking
ExecStart=/usr/local/etc/3proxy/bin/3proxy /usr/local/etc/3proxy/3proxy.cfg
ExecStop=/bin/kill -TERM \$MAINPID
RemainAfterExit=yes
Restart=always
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable 3proxy 2>/dev/null

echo -e "${GREEN}✅ Cấu hình xong${NC}"

create_warp_service

echo -e "\n${YELLOW}[7/8] Khởi động...${NC}"

systemctl start cloudflare-warp-proxy.service
sleep 2

bash ${WORKDIR}/boot_iptables.sh 2>/dev/null
bash ${WORKDIR}/boot_ifconfig.sh 2>/dev/null

if command -v firewall-cmd >/dev/null 2>&1; then
    echo -e "${BLUE}Cấu hình firewall...${NC}"
    for port in $(seq $FIRST_PORT $LAST_PORT); do
        firewall-cmd --permanent --add-port=${port}/tcp 2>/dev/null
    done
    firewall-cmd --reload 2>/dev/null
fi

gen_proxy_file_for_user

echo -e "${BLUE}Khởi động 3proxy...${NC}"
systemctl start 3proxy
sleep 3

print_proxy

# ================================================================
# KIỂM TRA
# ================================================================

echo -e "\n${YELLOW}============================================${NC}"
echo -e "${YELLOW}  [8/8] KIỂM TRA${NC}"
echo -e "${YELLOW}============================================${NC}"

# Kiểm tra WARP proxy
if netstat -tuln 2>/dev/null | grep -q ":40000" || ss -tuln 2>/dev/null | grep -q ":40000"; then
    echo -e "${GREEN}✅ WARP Proxy: OK (port 40000)${NC}"
    WARP_OK=true
else
    echo -e "${RED}❌ WARP Proxy: Chưa chạy${NC}"
    WARP_OK=false
fi

if systemctl is-active --quiet 3proxy; then
    echo -e "${GREEN}✅ 3proxy: Running${NC}"
else
    echo -e "${RED}❌ 3proxy: Lỗi${NC}"
    journalctl -u 3proxy -n 10 --no-pager
fi

# Test proxy
echo -e "\n${BLUE}Test proxy...${NC}"
TEST_PROXY=$(head -1 proxy.txt)

if [ -n "$TEST_PROXY" ]; then
    echo -e "${YELLOW}Đang test: ${TEST_PROXY}${NC}"
    TEST_RESULT=$(timeout 15 curl -x socks5://${TEST_PROXY} -s https://api.ipify.org 2>/dev/null)
    
    if [ -n "$TEST_RESULT" ]; then
        echo -e "${GREEN}✅ Proxy hoạt động: IP = ${TEST_RESULT}${NC}"
        if [ "$TEST_RESULT" != "$IP4" ]; then
            echo -e "${GREEN}✅ Đang qua Cloudflare${NC}"
        else
            echo -e "${YELLOW}⚠️  IP giống VPS${NC}"
        fi
    else
        echo -e "${YELLOW}⚠️  Timeout (thử lại sau)${NC}"
    fi
fi

# ================================================================
# HƯỚNG DẪN
# ================================================================

echo -e "\n${GREEN}============================================${NC}"
echo -e "${GREEN}  HOÀN TẤT!${NC}"
echo -e "${GREEN}============================================${NC}"

cat > ${WORKDIR}/HUONG-DAN.txt <<EOF
================================================
  HƯỚNG DẪN SỬ DỤNG
================================================

FILE: ${WORKDIR}/proxy.txt
Số lượng: ${COUNT} proxy
Port: ${FIRST_PORT} - ${LAST_PORT}

CẤU TRÚC:
  Client → 3proxy → WARP Proxy (127.0.0.1:40000) → Cloudflare

TEST:
  curl -x socks5://${TEST_PROXY} https://api.ipify.org

KIỂM TRA:
  netstat -tuln | grep 40000   # WARP proxy
  systemctl status 3proxy
  warp-cli status

KHẮC PHỤC:
  systemctl restart warp-svc
  warp-cli mode proxy
  systemctl restart 3proxy

LOGS:
  journalctl -u 3proxy -f
  journalctl -u warp-svc -f

LƯU Ý: WARP ở chế độ PROXY, SSH an toàn.
================================================
EOF

echo -e "${YELLOW}File: ${WORKDIR}/HUONG-DAN.txt${NC}"

if [ "$WARP_OK" = false ]; then
    echo -e "\n${YELLOW}⚠️  WARP proxy chưa chạy${NC}"
    echo -e "${YELLOW}Chạy: systemctl restart warp-svc${NC}"
    echo -e "${YELLOW}      warp-cli mode proxy${NC}"
fi

echo -e "\n${GREEN}✅ Hoàn tất! SSH an toàn.${NC}"

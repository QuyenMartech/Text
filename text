#!/bin/bash

if [ "$(id -u)" != "0" ]; then
    echo "❌ Script phải chạy với quyền root"
    exit 1
fi

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${GREEN}============================================${NC}"
echo -e "${GREEN}  3proxy + WARP v4.0 (SSH-Safe)${NC}"
echo -e "${GREEN}============================================${NC}"

# ================================================================
# LƯU Ý QUAN TRỌNG
# ================================================================
echo -e "\n${YELLOW}⚠️  LƯU Ý QUAN TRỌNG:${NC}"
echo -e "${YELLOW}Script này sẽ cấu hình WARP mode 'proxy' thay vì 'warp'${NC}"
echo -e "${YELLOW}để tránh mất kết nối SSH.${NC}"
echo -e "\n${BLUE}Nhấn Enter để tiếp tục, hoặc Ctrl+C để hủy...${NC}"
read

# ================================================================
# PHẦN 1: CÀI ĐẶT WARP
# ================================================================

install_cloudflare_warp() {
    echo -e "\n${YELLOW}[1/8] Cài đặt Cloudflare WARP...${NC}"
    
    if [ -f /etc/redhat-release ]; then
        echo -e "${BLUE}CentOS/RHEL${NC}"
        curl -fsSL https://pkg.cloudflareclient.com/cloudflare-warp-ascii.repo | tee /etc/yum.repos.d/cloudflare-warp.repo >/dev/null
        yum install -y cloudflare-warp >/dev/null 2>&1
    elif [ -f /etc/debian_version ]; then
        echo -e "${BLUE}Debian/Ubuntu${NC}"
        curl -fsSL https://pkg.cloudflareclient.com/pubkey.gpg | gpg --dearmor -o /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg
        echo "deb [arch=amd64 signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] https://pkg.cloudflareclient.com/ $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/cloudflare-client.list
        apt-get update -qq
        apt-get install -y cloudflare-warp >/dev/null 2>&1
    fi
    
    echo -e "${GREEN}✅ Đã cài đặt${NC}"
}

configure_cloudflare_warp() {
    echo -e "\n${YELLOW}[2/8] Cấu hình WARP (Proxy Mode - An toàn SSH)...${NC}"
    
    systemctl enable warp-svc >/dev/null 2>&1
    systemctl restart warp-svc
    sleep 5
    
    warp-cli registration delete >/dev/null 2>&1
    sleep 2
    
    echo -e "${BLUE}Đăng ký WARP...${NC}"
    
    # Sử dụng expect
    cat > /tmp/warp-reg.exp <<'EXPECT'
#!/usr/bin/expect -f
set timeout 30
spawn warp-cli registration new
expect {
    "Accept*?" { send "y\r"; exp_continue }
    "y/N" { send "y\r"; exp_continue }
    "Success" { exit 0 }
    timeout { exit 1 }
    eof
}
EXPECT
    
    chmod +x /tmp/warp-reg.exp
    /tmp/warp-reg.exp 2>/dev/null || echo -e "y\ny\ny" | warp-cli registration new 2>/dev/null
    rm -f /tmp/warp-reg.exp
    sleep 3
    
    # ================================================================
    # QUAN TRỌNG: Dùng PROXY MODE thay vì WARP MODE
    # ================================================================
    echo -e "${BLUE}Đặt chế độ PROXY (an toàn cho SSH)...${NC}"
    warp-cli mode proxy 2>/dev/null
    sleep 2
    
    echo -e "${GREEN}✅ WARP đang chạy ở chế độ PROXY (port 40000)${NC}"
    echo -e "${YELLOW}⚠️  KHÔNG kết nối WARP global để tránh mất SSH${NC}"
}

# ================================================================
# PHẦN 2: HÀM GỐC
# ================================================================

random() {
    tr </dev/urandom -dc A-Za-z0-9 | head -c8
    echo
}

array=(1 2 3 4 5 6 7 8 9 0 a b c d e f)
gen64() {
    ip64() {
        echo "${array[$RANDOM % 16]}${array[$RANDOM % 16]}${array[$RANDOM % 16]}${array[$RANDOM % 16]}"
    }
    echo "$1:$(ip64):$(ip64):$(ip64):$(ip64)"
}

install_3proxy() {
    echo -e "\n${YELLOW}[3/8] Cài đặt 3proxy...${NC}"
    URL="https://raw.githubusercontent.com/quayvlog/quayvlog/main/3proxy-3proxy-0.8.6.tar.gz"
    wget -qO- $URL | bsdtar -xvf- >/dev/null 2>&1
    cd 3proxy-3proxy-0.8.6
    make -f Makefile.Linux >/dev/null 2>&1
    mkdir -p /usr/local/etc/3proxy/{bin,logs,stat}
    cp src/3proxy /usr/local/etc/3proxy/bin/
    cd $WORKDIR
    echo -e "${GREEN}✅ Đã cài đặt${NC}"
}

# ================================================================
# PHẦN 3: CẤU HÌNH 3PROXY ĐỂ DÙNG WARP PROXY
# ================================================================

gen_3proxy() {
    cat <<EOF
daemon
maxconn 2000
nscache 65535
timeouts 1 5 30 60 180 1800 15 60
setgid 65535
setuid 65535
flush

# ============================================
# Routing qua Cloudflare WARP SOCKS5 Proxy
# WARP chạy ở 127.0.0.1:40000
# ============================================

# Định nghĩa parent proxy (WARP SOCKS5)
parent 1000 socks5 127.0.0.1 40000

auth strong

users $(awk -F "/" 'BEGIN{ORS="";} {print $1 ":CL:" $2 " "}' ${WORKDATA})

$(awk -F "/" '{print "auth strong\nallow " $1 "\n# Route traffic qua WARP parent proxy\nparent 1000\nproxy -6 -n -a -p" $4 " -i" $3 " -e"$5 "\nflush\n"}' ${WORKDATA})
EOF
}

gen_proxy_file_for_user() {
    cat >proxy.txt <<EOF
$(awk -F "/" '{print $3 ":" $4 ":" $1 ":" $2 }' ${WORKDATA})
EOF
}

print_proxy() {
    echo -e "\n${GREEN}============================================${NC}"
    echo -e "${GREEN}  ✅ PROXY ĐÃ SẴN SÀNG!${NC}"
    echo -e "${GREEN}============================================${NC}"
    echo -e "${BLUE}Format: IP:PORT:USERNAME:PASSWORD${NC}"
    echo -e "${YELLOW}File: ${WORKDIR}/proxy.txt${NC}\n"
    head -10 proxy.txt
    TOTAL=$(wc -l < proxy.txt)
    if [ $TOTAL -gt 10 ]; then
        echo -e "\n${BLUE}... và $((TOTAL - 10)) proxy khác${NC}"
    fi
}

gen_data() {
    seq $FIRST_PORT $LAST_PORT | while read port; do
        echo "usr$(random)/pass$(random)/$IP4/$port/$(gen64 $IP6)"
    done
}

gen_iptables() {
    cat <<EOF
$(awk -F "/" '{print "iptables -I INPUT -p tcp --dport " $4 " -m state --state NEW -j ACCEPT"}' ${WORKDATA})
EOF
}

gen_ifconfig() {
    cat <<EOF
$(awk -F "/" '{print "ip -6 addr add " $5 "/64 dev enp1s0"}' ${WORKDATA})
EOF
}

# ================================================================
# PHẦN 4: KHÔNG CẦN ROUTING TABLE PHỨC TẠP
# ================================================================

create_warp_service() {
    echo -e "\n${YELLOW}[6/8] Tạo WARP service...${NC}"
    
    # Service đơn giản, chỉ đảm bảo WARP proxy chạy
    cat >/etc/systemd/system/cloudflare-warp-proxy.service <<EOF
[Unit]
Description=Cloudflare WARP Proxy Mode
Before=3proxy.service
After=network.target warp-svc.service
Requires=warp-svc.service

[Service]
Type=oneshot
# Chỉ đảm bảo WARP ở chế độ proxy, KHÔNG connect
ExecStart=/usr/bin/warp-cli mode proxy
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF

    systemctl daemon-reload
    systemctl enable warp-svc >/dev/null 2>&1
    systemctl enable cloudflare-warp-proxy.service >/dev/null 2>&1
    
    echo -e "${GREEN}✅ Service đã tạo${NC}"
}

# ================================================================
# MAIN EXECUTION
# ================================================================

echo -e "\n${YELLOW}[0/8] Cài đặt gói...${NC}"
if [ -f /etc/redhat-release ]; then
    yum -y install gcc net-tools bsdtar zip curl expect >/dev/null 2>&1
else
    apt-get update -qq
    apt-get install -y gcc net-tools bsdtar zip curl expect >/dev/null 2>&1
fi
echo -e "${GREEN}✅ Done${NC}"

install_cloudflare_warp
configure_cloudflare_warp

install_3proxy

echo -e "\n${YELLOW}[4/8] Thiết lập...${NC}"
WORKDIR="/home/proxy-installer"
WORKDATA="${WORKDIR}/data.txt"
mkdir -p $WORKDIR && cd $_

IP4=$(curl -4 -s icanhazip.com)
IP6=$(curl -6 -s icanhazip.com | cut -f1-4 -d':')

echo -e "${BLUE}VPS IP:${NC}"
echo -e "  IPv4: ${GREEN}${IP4}${NC}"
echo -e "  IPv6: ${GREEN}${IP6}${NC}"

echo -e "\n${YELLOW}Số lượng proxy:${NC}"
read COUNT

FIRST_PORT=10000
LAST_PORT=$(($FIRST_PORT + $COUNT - 1))

echo -e "\n${YELLOW}[5/8] Tạo cấu hình...${NC}"
gen_data >$WORKDIR/data.txt
gen_iptables >$WORKDIR/boot_iptables.sh
gen_ifconfig >$WORKDIR/boot_ifconfig.sh
chmod +x ${WORKDIR}/boot_*.sh

gen_3proxy >/usr/local/etc/3proxy/3proxy.cfg

echo "* soft nofile 65535" >> /etc/security/limits.conf
echo "* hard nofile 65535" >> /etc/security/limits.conf

cat >/etc/systemd/system/3proxy.service <<EOF
[Unit]
Description=3proxy tiny proxy server
After=network.target cloudflare-warp-proxy.service
Wants=cloudflare-warp-proxy.service

[Service]
Type=forking
ExecStart=/usr/local/etc/3proxy/bin/3proxy /usr/local/etc/3proxy/3proxy.cfg
ExecStop=/bin/kill -TERM \$MAINPID
RemainAfterExit=yes
Restart=always
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable 3proxy >/dev/null 2>&1

echo -e "${GREEN}✅ Done${NC}"

create_warp_service

echo -e "\n${YELLOW}[7/8] Khởi động...${NC}"

systemctl start cloudflare-warp-proxy.service
sleep 2

bash ${WORKDIR}/boot_iptables.sh 2>/dev/null
bash ${WORKDIR}/boot_ifconfig.sh 2>/dev/null

if command -v firewall-cmd >/dev/null 2>&1; then
    for port in $(seq $FIRST_PORT $LAST_PORT); do
        firewall-cmd --permanent --add-port=${port}/tcp 2>/dev/null
    done
    firewall-cmd --reload 2>/dev/null
fi

gen_proxy_file_for_user
systemctl start 3proxy
sleep 3

print_proxy

# ================================================================
# KIỂM TRA
# ================================================================

echo -e "\n${YELLOW}============================================${NC}"
echo -e "${YELLOW}  KIỂM TRA${NC}"
echo -e "${YELLOW}============================================${NC}"

# Kiểm tra WARP proxy
if netstat -tuln | grep -q ":40000"; then
    echo -e "${GREEN}✅ WARP Proxy: Hoạt động (port 40000)${NC}"
    WARP_OK=true
else
    echo -e "${RED}❌ WARP Proxy: Chưa chạy${NC}"
    WARP_OK=false
fi

if systemctl is-active --quiet 3proxy; then
    echo -e "${GREEN}✅ 3proxy: Running${NC}"
else
    echo -e "${RED}❌ 3proxy: Error${NC}"
fi

# Test proxy
echo -e "\n${BLUE}Test proxy...${NC}"
TEST_PROXY=$(head -1 proxy.txt)
TEST_RESULT=$(timeout 15 curl -x socks5://${TEST_PROXY} -s https://api.ipify.org 2>/dev/null)

if [ -n "$TEST_RESULT" ]; then
    echo -e "${GREEN}✅ Proxy OK: IP = ${TEST_RESULT}${NC}"
    if [ "$TEST_RESULT" != "$IP4" ]; then
        echo -e "${GREEN}✅ Đang qua Cloudflare${NC}"
    else
        echo -e "${YELLOW}⚠️  IP = VPS (WARP có thể chưa hoạt động)${NC}"
    fi
else
    echo -e "${YELLOW}⚠️  Chưa test được${NC}"
fi

# ================================================================
# HƯỚNG DẪN
# ================================================================

echo -e "\n${GREEN}============================================${NC}"
echo -e "${GREEN}  HOÀN TẤT!${NC}"
echo -e "${GREEN}============================================${NC}"

cat > ${WORKDIR}/HUONG-DAN.txt <<EOF
================================================
  HƯỚNG DẪN
================================================

FILE: ${WORKDIR}/proxy.txt
Số lượng: ${COUNT}
Port: ${FIRST_PORT} - ${LAST_PORT}

CẤU TRÚC HOẠT ĐỘNG:
  Client → 3proxy (port ${FIRST_PORT}+) 
         → WARP Proxy (127.0.0.1:40000) 
         → Cloudflare → Internet

TEST:
  curl -x socks5://${TEST_PROXY} https://api.ipify.org

KIỂM TRA WARP PROXY:
  netstat -tuln | grep 40000
  warp-cli status

KHẮC PHỤC NẾU WARP KHÔNG HOẠT ĐỘNG:
  1. warp-cli registration delete
  2. warp-cli registration new  (nhập 'y')
  3. warp-cli mode proxy
  4. systemctl restart 3proxy

LOGS:
  - 3proxy: journalctl -u 3proxy -f
  - WARP: warp-cli status

LƯU Ý:
  - WARP chạy ở chế độ PROXY, KHÔNG chiếm routing
  - SSH của bạn AN TOÀN, không bị disconnect
  - 3proxy chuyển tiếp traffic qua WARP proxy

================================================
EOF

echo -e "${YELLOW}File: ${WORKDIR}/HUONG-DAN.txt${NC}"

if [ "$WARP_OK" = true ]; then
    echo -e "\n${GREEN}✅ Tất cả hoạt động tốt!${NC}"
else
    echo -e "\n${YELLOW}⚠️  WARP proxy chưa chạy${NC}"
    echo -e "${YELLOW}Chạy: warp-cli mode proxy${NC}"
    echo -e "${YELLOW}Sau đó: systemctl restart 3proxy${NC}"
fi

echo -e "\n${GREEN}✅ Script hoàn tất! SSH vẫn an toàn.${NC}"

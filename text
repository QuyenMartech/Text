#!/bin/bash
# ================================================================
# Script: 3proxy + Cloudflare WARP (FINAL WORKING VERSION)
# Version: 5.0 - Complete working solution
# ================================================================

if [ "$(id -u)" != "0" ]; then
    echo "❌ Cần quyền root"
    exit 1
fi

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${GREEN}============================================${NC}"
echo -e "${GREEN}  3proxy + WARP v5.0 (WORKING)${NC}"
echo -e "${GREEN}============================================${NC}"

echo -e "\n${YELLOW}⚠️  Script sẽ:${NC}"
echo -e "${YELLOW}1. Cài đặt WARP ở chế độ PROXY${NC}"
echo -e "${YELLOW}2. WARP sẽ CONNECT để mở port 40000${NC}"
echo -e "${YELLOW}3. SSH vẫn an toàn (không bị chiếm routing)${NC}"
echo -e "\n${BLUE}Nhấn Enter để tiếp tục...${NC}"
read

# ================================================================
# CÀI ĐẶT GÓI
# ================================================================

install_packages() {
    echo -e "\n${YELLOW}[0/8] Cài đặt gói...${NC}"
    
    if [ -f /etc/redhat-release ]; then
        yum install -y gcc net-tools bsdtar zip curl expect 2>&1 | tail -3
    else
        apt-get update -qq
        apt-get install -y gcc net-tools bsdtar zip curl expect 2>&1 | tail -3
    fi
    
    echo -e "${GREEN}✅ Done${NC}"
}

# ================================================================
# CÀI ĐẶT WARP
# ================================================================

install_cloudflare_warp() {
    echo -e "\n${YELLOW}[1/8] Cài đặt WARP...${NC}"
    
    if [ -f /etc/redhat-release ]; then
        curl -fsSL https://pkg.cloudflareclient.com/cloudflare-warp-ascii.repo | tee /etc/yum.repos.d/cloudflare-warp.repo >/dev/null
        yum install -y cloudflare-warp 2>&1 | tail -3
    else
        curl -fsSL https://pkg.cloudflareclient.com/pubkey.gpg | gpg --dearmor -o /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg
        echo "deb [arch=amd64 signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] https://pkg.cloudflareclient.com/ $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/cloudflare-client.list
        apt-get update -qq
        apt-get install -y cloudflare-warp 2>&1 | tail -3
    fi
    
    echo -e "${GREEN}✅ Done${NC}"
}

configure_cloudflare_warp() {
    echo -e "\n${YELLOW}[2/8] Cấu hình WARP...${NC}"
    
    # Khởi động service
    echo -e "${BLUE}Khởi động warp-svc...${NC}"
    systemctl enable warp-svc 2>/dev/null
    systemctl restart warp-svc
    sleep 5
    
    # Xóa registration cũ
    echo -e "${BLUE}Reset WARP...${NC}"
    warp-cli disconnect 2>/dev/null
    warp-cli registration delete 2>/dev/null
    sleep 2
    
    # Đăng ký
    echo -e "${BLUE}Đăng ký WARP...${NC}"
    cat > /tmp/warp-reg.exp <<'EXPECT'
#!/usr/bin/expect -f
set timeout 30
spawn warp-cli registration new
expect {
    "Accept*?" { send "y\r"; exp_continue }
    "y/N" { send "y\r"; exp_continue }
    "Success" { exit 0 }
    timeout { exit 1 }
    eof
}
EXPECT
    
    chmod +x /tmp/warp-reg.exp
    /tmp/warp-reg.exp 2>/dev/null || echo -e "y\ny\ny" | warp-cli registration new 2>/dev/null
    rm -f /tmp/warp-reg.exp
    sleep 3
    
    # ================================================================
    # QUAN TRỌNG: Đặt chế độ PROXY + CONNECT
    # ================================================================
    echo -e "${BLUE}Đặt chế độ PROXY...${NC}"
    warp-cli mode proxy
    sleep 2
    
    echo -e "${BLUE}⚡ CONNECTING WARP (để mở port 40000)...${NC}"
    warp-cli connect
    sleep 8
    
    # Kiểm tra nhiều lần
    echo -e "${BLUE}Kiểm tra WARP proxy...${NC}"
    for i in {1..10}; do
        if netstat -tuln 2>/dev/null | grep -q ":40000" || ss -tuln 2>/dev/null | grep -q ":40000"; then
            echo -e "${GREEN}✅ WARP Proxy HOẠT ĐỘNG (port 40000)${NC}"
            
            # Test IP qua WARP
            WARP_IP=$(curl -x socks5://127.0.0.1:40000 -s --connect-timeout 10 https://api.ipify.org 2>/dev/null)
            if [ -n "$WARP_IP" ]; then
                echo -e "${GREEN}✅ IP qua WARP: ${WARP_IP}${NC}"
            fi
            
            return 0
        fi
        
        echo -e "${YELLOW}⏳ Đợi WARP proxy... (lần $i/10)${NC}"
        sleep 3
    done
    
    echo -e "${RED}❌ WARP proxy không mở port 40000${NC}"
    echo -e "${YELLOW}Proxy sẽ KHÔNG đi qua Cloudflare${NC}"
}

# ================================================================
# HÀM GỐC
# ================================================================

random() {
    tr </dev/urandom -dc A-Za-z0-9 | head -c8
    echo
}

array=(1 2 3 4 5 6 7 8 9 0 a b c d e f)
gen64() {
    ip64() {
        echo "${array[$RANDOM % 16]}${array[$RANDOM % 16]}${array[$RANDOM % 16]}${array[$RANDOM % 16]}"
    }
    echo "$1:$(ip64):$(ip64):$(ip64):$(ip64)"
}

install_3proxy() {
    echo -e "\n${YELLOW}[3/8] Cài đặt 3proxy...${NC}"
    
    URL="https://raw.githubusercontent.com/quayvlog/quayvlog/main/3proxy-3proxy-0.8.6.tar.gz"
    wget -qO- $URL | bsdtar -xvf- 2>&1 | head -3
    cd 3proxy-3proxy-0.8.6
    make -f Makefile.Linux 2>&1 | tail -2
    mkdir -p /usr/local/etc/3proxy/{bin,logs,stat}
    cp src/3proxy /usr/local/etc/3proxy/bin/
    cd $WORKDIR
    
    echo -e "${GREEN}✅ Done${NC}"
}

gen_3proxy() {
    cat <<EOF
daemon
maxconn 2000
nscache 65535
timeouts 1 5 30 60 180 1800 15 60
setgid 65535
setuid 65535
flush

# Route qua WARP SOCKS5 Proxy
parent 1000 socks5 127.0.0.1 40000

auth strong

users $(awk -F "/" 'BEGIN{ORS="";} {print $1 ":CL:" $2 " "}' ${WORKDATA})

$(awk -F "/" '{print "auth strong\nallow " $1 "\nparent 1000\nproxy -6 -n -a -p" $4 " -i" $3 " -e"$5 "\nflush\n"}' ${WORKDATA})
EOF
}

gen_proxy_file_for_user() {
    cat >proxy.txt <<EOF
$(awk -F "/" '{print $3 ":" $4 ":" $1 ":" $2 }' ${WORKDATA})
EOF
}

print_proxy() {
    echo -e "\n${GREEN}============================================${NC}"
    echo -e "${GREEN}  ✅ PROXY SẴN SÀNG!${NC}"
    echo -e "${GREEN}============================================${NC}"
    echo -e "${BLUE}Format: IP:PORT:USER:PASS${NC}"
    echo -e "${YELLOW}File: ${WORKDIR}/proxy.txt${NC}\n"
    head -10 proxy.txt
    TOTAL=$(wc -l < proxy.txt)
    if [ $TOTAL -gt 10 ]; then
        echo -e "\n${BLUE}... và $((TOTAL - 10)) proxy khác${NC}"
    fi
}

gen_data() {
    seq $FIRST_PORT $LAST_PORT | while read port; do
        echo "usr$(random)/pass$(random)/$IP4/$port/$(gen64 $IP6)"
    done
}

gen_iptables() {
    cat <<EOF
$(awk -F "/" '{print "iptables -I INPUT -p tcp --dport " $4 " -m state --state NEW -j ACCEPT"}' ${WORKDATA})
EOF
}

gen_ifconfig() {
    cat <<EOF
$(awk -F "/" '{print "ip -6 addr add " $5 "/64 dev enp1s0"}' ${WORKDATA})
EOF
}

create_warp_service() {
    echo -e "\n${YELLOW}[6/8] Tạo service...${NC}"
    
    # Service tự động connect WARP khi boot
    cat >/etc/systemd/system/cloudflare-warp-proxy.service <<EOF
[Unit]
Description=Cloudflare WARP Proxy Mode
Before=3proxy.service
After=network.target warp-svc.service
Requires=warp-svc.service

[Service]
Type=oneshot
ExecStart=/usr/bin/warp-cli mode proxy
ExecStartPost=/bin/sleep 3
ExecStartPost=/usr/bin/warp-cli connect
RemainAfterExit=yes
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

    systemctl daemon-reload
    systemctl enable warp-svc 2>/dev/null
    systemctl enable cloudflare-warp-proxy.service 2>/dev/null
    
    echo -e "${GREEN}✅ Done${NC}"
}

# ================================================================
# MAIN
# ================================================================

install_packages
install_cloudflare_warp
configure_cloudflare_warp

install_3proxy

echo -e "\n${YELLOW}[4/8] Thiết lập...${NC}"
WORKDIR="/home/proxy-installer"
WORKDATA="${WORKDIR}/data.txt"
mkdir -p $WORKDIR && cd $_

IP4=$(curl -4 -s icanhazip.com)
IP6=$(curl -6 -s icanhazip.com | cut -f1-4 -d':')

echo -e "${BLUE}VPS:${NC}"
echo -e "  IPv4: ${GREEN}${IP4}${NC}"
echo -e "  IPv6: ${GREEN}${IP6}${NC}"

echo -e "\n${YELLOW}Số lượng proxy:${NC}"
read COUNT

FIRST_PORT=10000
LAST_PORT=$(($FIRST_PORT + $COUNT - 1))

echo -e "\n${YELLOW}[5/8] Tạo cấu hình...${NC}"
gen_data >$WORKDIR/data.txt
gen_iptables >$WORKDIR/boot_iptables.sh
gen_ifconfig >$WORKDIR/boot_ifconfig.sh
chmod +x ${WORKDIR}/boot_*.sh

gen_3proxy >/usr/local/etc/3proxy/3proxy.cfg

echo "* soft nofile 65535" >> /etc/security/limits.conf
echo "* hard nofile 65535" >> /etc/security/limits.conf

cat >/etc/systemd/system/3proxy.service <<EOF
[Unit]
Description=3proxy tiny proxy server
After=network.target cloudflare-warp-proxy.service
Wants=cloudflare-warp-proxy.service

[Service]
Type=forking
ExecStart=/usr/local/etc/3proxy/bin/3proxy /usr/local/etc/3proxy/3proxy.cfg
ExecStop=/bin/kill -TERM \$MAINPID
RemainAfterExit=yes
Restart=always
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable 3proxy 2>/dev/null

echo -e "${GREEN}✅ Done${NC}"

create_warp_service

echo -e "\n${YELLOW}[7/8] Khởi động...${NC}"

systemctl start cloudflare-warp-proxy.service
sleep 3

bash ${WORKDIR}/boot_iptables.sh 2>/dev/null
bash ${WORKDIR}/boot_ifconfig.sh 2>/dev/null

if command -v firewall-cmd >/dev/null 2>&1; then
    echo -e "${BLUE}Firewall...${NC}"
    for port in $(seq $FIRST_PORT $LAST_PORT); do
        firewall-cmd --permanent --add-port=${port}/tcp 2>/dev/null
    done
    firewall-cmd --reload 2>/dev/null
fi

gen_proxy_file_for_user

echo -e "${BLUE}Khởi động 3proxy...${NC}"
systemctl start 3proxy
sleep 3

print_proxy

# ================================================================
# KIỂM TRA CUỐI CÙNG
# ================================================================

echo -e "\n${YELLOW}============================================${NC}"
echo -e "${YELLOW}  [8/8] KIỂM TRA CUỐI CÙNG${NC}"
echo -e "${YELLOW}============================================${NC}"

# Kiểm tra WARP proxy
echo -e "${BLUE}Kiểm tra WARP proxy port 40000...${NC}"
if netstat -tuln 2>/dev/null | grep -q ":40000" || ss -tuln 2>/dev/null | grep -q ":40000"; then
    echo -e "${GREEN}✅ WARP Proxy: HOẠT ĐỘNG${NC}"
    WARP_OK=true
    
    # Test IP qua WARP
    WARP_TEST_IP=$(curl -x socks5://127.0.0.1:40000 -s --connect-timeout 10 https://api.ipify.org 2>/dev/null)
    if [ -n "$WARP_TEST_IP" ]; then
        echo -e "${GREEN}   IP qua WARP: ${WARP_TEST_IP}${NC}"
    fi
else
    echo -e "${RED}❌ WARP Proxy: KHÔNG HOẠT ĐỘNG${NC}"
    WARP_OK=false
fi

# Kiểm tra 3proxy
if systemctl is-active --quiet 3proxy; then
    echo -e "${GREEN}✅ 3proxy: Running${NC}"
else
    echo -e "${RED}❌ 3proxy: Lỗi${NC}"
fi

# Test proxy thực tế
echo -e "\n${BLUE}Test proxy thực tế...${NC}"
TEST_PROXY=$(head -1 proxy.txt)

if [ -n "$TEST_PROXY" ]; then
    echo -e "${YELLOW}Proxy: ${TEST_PROXY}${NC}"
    
    # Test 3 lần
    for i in {1..3}; do
        TEST_RESULT=$(timeout 15 curl -x socks5://${TEST_PROXY} -s https://api.ipify.org 2>/dev/null)
        
        if [ -n "$TEST_RESULT" ]; then
            echo -e "${GREEN}✅ Lần $i: IP = ${TEST_RESULT}${NC}"
            
            if [ "$TEST_RESULT" != "$IP4" ]; then
                echo -e "${GREEN}   ✅ IP khác VPS → Đang qua Cloudflare!${NC}"
            else
                echo -e "${YELLOW}   ⚠️  IP = VPS → WARP chưa hoạt động${NC}"
            fi
            break
        else
            if [ $i -lt 3 ]; then
                echo -e "${YELLOW}⏳ Lần $i timeout, thử lại...${NC}"
                sleep 3
            else
                echo -e "${YELLOW}⚠️  Timeout sau 3 lần thử${NC}"
            fi
        fi
    done
fi

# ================================================================
# KẾT QUẢ
# ================================================================

echo -e "\n${GREEN}============================================${NC}"
echo -e "${GREEN}  KẾT QUẢ${NC}"
echo -e "${GREEN}============================================${NC}"

if [ "$WARP_OK" = true ]; then
    echo -e "${GREEN}✅ HOÀN TẤT THÀNH CÔNG!${NC}"
    echo -e "${GREEN}   Proxy của bạn ĐÃ có lớp Cloudflare${NC}"
    echo -e "${GREEN}   File: ${WORKDIR}/proxy.txt${NC}"
else
    echo -e "${YELLOW}⚠️  HOÀN TẤT NHƯNG WARP CHƯA HOẠT ĐỘNG${NC}"
    echo -e "${YELLOW}   Proxy vẫn dùng được nhưng CHƯA qua Cloudflare${NC}"
    echo -e "\n${BLUE}Khắc phục:${NC}"
    echo -e "${BLUE}1. systemctl restart warp-svc${NC}"
    echo -e "${BLUE}2. warp-cli mode proxy${NC}"
    echo -e "${BLUE}3. warp-cli connect${NC}"
    echo -e "${BLUE}4. Đợi 10 giây${NC}"
    echo -e "${BLUE}5. netstat -tuln | grep 40000  ${NC}${YELLOW}(phải thấy port 40000)${NC}"
    echo -e "${BLUE}6. systemctl restart 3proxy${NC}"
fi

# Lưu hướng dẫn
cat > ${WORKDIR}/HUONG-DAN.txt <<EOF
================================================
  HƯỚNG DẪN
================================================

FILE: ${WORKDIR}/proxy.txt
Số lượng: ${COUNT} proxy
Port: ${FIRST_PORT} - ${LAST_PORT}

CẤU TRÚC:
  Client → 3proxy (port ${FIRST_PORT}+)
         → WARP Proxy (127.0.0.1:40000)
         → Cloudflare
         → Internet

KIỂM TRA WARP HOẠT ĐỘNG:
  netstat -tuln | grep 40000
  (Phải thấy: 127.0.0.1:40000)

TEST PROXY:
  curl -x socks5://${TEST_PROXY} https://api.ipify.org
  (IP phải KHÁC ${IP4})

TEST WARP TRỰC TIẾP:
  curl -x socks5://127.0.0.1:40000 https://api.ipify.org

KHẮC PHỤC NẾU WARP KHÔNG HOẠT ĐỘNG:
  systemctl restart warp-svc
  warp-cli mode proxy
  warp-cli connect
  sleep 10
  netstat -tuln | grep 40000
  systemctl restart 3proxy

LOGS:
  journalctl -u 3proxy -f
  journalctl -u warp-svc -f
  warp-cli status

================================================
EOF

echo -e "\n${YELLOW}Hướng dẫn: ${WORKDIR}/HUONG-DAN.txt${NC}"
echo -e "${GREEN}✅ Script hoàn tất!${NC}"

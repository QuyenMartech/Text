#!/bin/bash

if [ "$(id -u)" != "0" ]; then
    echo "This script must be run as root" 1>&2
    exit 1
fi

random() {
    tr </dev/urandom -dc A-Za-z0-9 | head -c8
    echo
}

array=(1 2 3 4 5 6 7 8 9 0 a b c d e f)
gen64() {
    ip64() {
        echo "${array[$RANDOM % 16]}${array[$RANDOM % 16]}${array[$RANDOM % 16]}${array[$RANDOM % 16]}"
    }
    echo "$1:$(ip64):$(ip64):$(ip64):$(ip64)"
}

# ================================================================
# C√ÄI ƒê·∫∂T WARP
# ================================================================

install_cloudflare_warp() {
    echo "Installing Cloudflare WARP..."
    
    if [ -f /etc/redhat-release ]; then
        curl -fsSL https://pkg.cloudflareclient.com/cloudflare-warp-ascii.repo | tee /etc/yum.repos.d/cloudflare-warp.repo >/dev/null
        yum install -y cloudflare-warp 2>&1 | tail -3
    else
        curl -fsSL https://pkg.cloudflareclient.com/pubkey.gpg | gpg --dearmor -o /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg
        echo "deb [arch=amd64 signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] https://pkg.cloudflareclient.com/ $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/cloudflare-client.list
        apt-get update -qq
        apt-get install -y cloudflare-warp 2>&1 | tail -3
    fi
    
    echo "‚úÖ WARP installed"
}

configure_cloudflare_warp() {
    echo "Configuring Cloudflare WARP..."
    
    systemctl enable warp-svc 2>/dev/null
    systemctl restart warp-svc
    sleep 5
    
    warp-cli disconnect 2>/dev/null
    warp-cli registration delete 2>/dev/null
    sleep 2
    
    echo "Registering WARP..."
    echo -e "y\ny\ny" | warp-cli registration new 2>/dev/null
    sleep 3
    
    echo "Setting proxy mode..."
    warp-cli mode proxy
    sleep 2
    
    echo "Connecting WARP (waiting 15 seconds)..."
    warp-cli connect
    sleep 15
    
    # Ki·ªÉm tra
    for i in {1..15}; do
        if netstat -tuln 2>/dev/null | grep -q ":40000" || ss -tuln 2>/dev/null | grep -q ":40000"; then
            echo "‚úÖ WARP Proxy ready (port 40000)"
            WARP_IP=$(curl -x socks5://127.0.0.1:40000 -s --connect-timeout 10 https://api.ipify.org 2>/dev/null)
            if [ -n "$WARP_IP" ]; then
                echo "‚úÖ IP via WARP: ${WARP_IP}"
            fi
            return 0
        fi
        echo "   Waiting... ($i/15)"
        sleep 2
    done
    
    echo "‚ùå WARP failed to start"
    return 1
}

# ================================================================
# C√ÄI ƒê·∫∂T 3PROXY
# ================================================================

install_3proxy() {
    echo "Installing 3proxy"
    URL="https://raw.githubusercontent.com/quayvlog/quayvlog/main/3proxy-3proxy-0.8.6.tar.gz"
    wget -qO- $URL | bsdtar -xvf-
    cd 3proxy-3proxy-0.8.6
    make -f Makefile.Linux
    mkdir -p /usr/local/etc/3proxy/{bin,logs,stat}
    cp src/3proxy /usr/local/etc/3proxy/bin/
    cd $WORKDIR
}

# ================================================================
# C·∫§U H√åNH 3PROXY - S·ª¨A L·∫†I ƒê√öNG
# ================================================================

gen_3proxy_with_warp() {
    cat <<EOF
daemon
maxconn 2000
nscache 65535
timeouts 1 5 30 60 180 1800 15 60
setgid 65535
setuid 65535
flush

# WARP Parent - √Åp d·ª•ng cho T·∫§T C·∫¢ proxy
parent 1 socks5 127.0.0.1 40000

auth strong

users $(awk -F "/" 'BEGIN{ORS="";} {print $1 ":CL:" $2 " "}' ${WORKDATA})

$(awk -F "/" '{print "auth strong\nallow " $1 "\nproxy -6 -n -a -p" $4 " -i" $3 " -e"$5 "\n"}' ${WORKDATA})
EOF
}

gen_3proxy_without_warp() {
    cat <<EOF
daemon
maxconn 2000
nscache 65535
timeouts 1 5 30 60 180 1800 15 60
setgid 65535
setuid 65535
flush
auth strong

users $(awk -F "/" 'BEGIN{ORS="";} {print $1 ":CL:" $2 " "}' ${WORKDATA})

$(awk -F "/" '{print "auth strong\nallow " $1 "\nproxy -6 -n -a -p" $4 " -i" $3 " -e"$5 "\n"}' ${WORKDATA})
EOF
}

gen_proxy_file_for_user() {
    cat >proxy.txt <<EOF
$(awk -F "/" '{print $3 ":" $4 ":" $1 ":" $2 }' ${WORKDATA})
EOF
}

print_proxy() {
    echo "Proxy is ready! Format IP:PORT:LOGIN:PASS"
    echo "Here are your proxy details:"
    cat proxy.txt
}

gen_data() {
    seq $FIRST_PORT $LAST_PORT | while read port; do
        echo "usr$(random)/pass$(random)/$IP4/$port/$(gen64 $IP6)"
    done
}

gen_iptables() {
    cat <<EOF
$(awk -F "/" '{print "iptables -I INPUT -p tcp --dport " $4 " -m state --state NEW -j ACCEPT"}' ${WORKDATA})
EOF
}

gen_ifconfig() {
    cat <<EOF
$(awk -F "/" '{print "ip -6 addr add " $5 "/64 dev enp1s0"}' ${WORKDATA})
EOF
}

# ================================================================
# MAIN
# ================================================================

echo "Installing required packages"
yum -y install gcc net-tools bsdtar zip curl expect >/dev/null

# C√†i WARP
install_cloudflare_warp
configure_cloudflare_warp
WARP_STATUS=$?

# C√†i 3proxy
install_3proxy

echo "Working folder = /home/proxy-installer"
WORKDIR="/home/proxy-installer"
WORKDATA="${WORKDIR}/data.txt"
mkdir -p $WORKDIR && cd $_

IP4=$(curl -4 -s icanhazip.com)
IP6=$(curl -6 -s icanhazip.com | cut -f1-4 -d':')

echo "Internal IP = ${IP4}. External subnet for IPv6 = ${IP6}"

echo "How many proxies do you want to create? Example: 500"
read COUNT

FIRST_PORT=10000
LAST_PORT=$(($FIRST_PORT + $COUNT - 1))

gen_data >$WORKDIR/data.txt
gen_iptables >$WORKDIR/boot_iptables.sh
gen_ifconfig >$WORKDIR/boot_ifconfig.sh
chmod +x ${WORKDIR}/boot_*.sh

# T·∫°o config d·ª±a v√†o WARP status
if [ $WARP_STATUS -eq 0 ]; then
    echo "Creating 3proxy config WITH WARP..."
    gen_3proxy_with_warp >/usr/local/etc/3proxy/3proxy.cfg
else
    echo "Creating 3proxy config WITHOUT WARP..."
    gen_3proxy_without_warp >/usr/local/etc/3proxy/3proxy.cfg
fi

echo "* soft nofile 65535" >> /etc/security/limits.conf
echo "* hard nofile 65535" >> /etc/security/limits.conf
echo "session required pam_limits.so" >> /etc/pam.d/common-session

# T·∫°o WARP service
cat >/etc/systemd/system/cloudflare-warp-proxy.service <<EOF
[Unit]
Description=Cloudflare WARP Proxy Mode
Before=3proxy.service
After=network.target warp-svc.service
Requires=warp-svc.service

[Service]
Type=oneshot
ExecStart=/usr/bin/warp-cli mode proxy
ExecStartPost=/bin/sleep 3
ExecStartPost=/usr/bin/warp-cli connect
RemainAfterExit=yes
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# T·∫°o 3proxy service
cat >/etc/systemd/system/3proxy.service <<EOF
[Unit]
Description=3proxy tiny proxy server
After=network.target cloudflare-warp-proxy.service
Wants=cloudflare-warp-proxy.service

[Service]
Type=forking
ExecStart=/usr/local/etc/3proxy/bin/3proxy /usr/local/etc/3proxy/3proxy.cfg
ExecStop=/bin/kill -TERM \$MAINPID
RemainAfterExit=yes
Restart=always
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable warp-svc 2>/dev/null
systemctl enable cloudflare-warp-proxy.service 2>/dev/null
systemctl enable 3proxy

# QUAN TR·ªåNG: Ch·∫°y setup nh∆∞ script g·ªëc
echo "Setting up iptables..."
bash ${WORKDIR}/boot_iptables.sh

echo "Setting up IPv6 interfaces..."
bash ${WORKDIR}/boot_ifconfig.sh

# Firewall
if command -v firewall-cmd >/dev/null 2>&1; then
    echo "Configuring firewall..."
    for port in $(seq $FIRST_PORT $LAST_PORT); do
        firewall-cmd --permanent --add-port=${port}/tcp 2>/dev/null
    done
    firewall-cmd --reload 2>/dev/null
fi

gen_proxy_file_for_user
print_proxy

# Kh·ªüi ƒë·ªông services
if [ $WARP_STATUS -eq 0 ]; then
    systemctl start cloudflare-warp-proxy.service
    sleep 5
fi

systemctl start 3proxy

echo "3proxy has been installed and configured."
echo "Check logs: /usr/local/etc/3proxy/logs/3proxy.log"

if systemctl is-active --quiet 3proxy; then
    echo "‚úÖ 3proxy is running"
else
    echo "‚ùå 3proxy failed to start"
    echo "Check logs: journalctl -u 3proxy"
fi

# Ki·ªÉm tra v√† restart n·∫øu c·∫ßn
if ! pgrep -x "3proxy" > /dev/null; then
    echo "3proxy not running. Attempting to start..."
    systemctl start 3proxy
    sleep 5
    if pgrep -x "3proxy" > /dev/null; then
        echo "‚úÖ 3proxy started successfully"
    else
        echo "‚ùå Failed to start 3proxy"
    fi
fi

# Hi·ªÉn th·ªã config
echo ""
echo "============================================"
echo "3proxy configuration:"
echo "============================================"
cat /usr/local/etc/3proxy/3proxy.cfg

# Test ports
echo ""
echo "Testing proxy connections..."
for port in $(seq $FIRST_PORT $((FIRST_PORT + 4))); do
    if nc -z localhost $port 2>/dev/null; then
        echo "‚úÖ Port $port is open and accessible"
    else
        echo "‚ùå Port $port is not accessible"
    fi
done

# ================================================================
# KI·ªÇM TRA CU·ªêI C√ôNG
# ================================================================

echo ""
echo "============================================"
echo "  FINAL CHECK"
echo "============================================"

# Check WARP
echo ""
echo "[1] WARP Status:"
if netstat -tuln 2>/dev/null | grep -q ":40000" || ss -tuln 2>/dev/null | grep -q ":40000"; then
    echo "‚úÖ WARP Proxy: WORKING (port 40000)"
    WARP_TEST=$(curl -x socks5://127.0.0.1:40000 -s --connect-timeout 10 https://api.ipify.org 2>/dev/null)
    if [ -n "$WARP_TEST" ]; then
        echo "   IP via WARP: ${WARP_TEST}"
    fi
else
    echo "‚ùå WARP Proxy: NOT WORKING"
fi

# Check 3proxy
echo ""
echo "[2] 3proxy Status:"
if systemctl is-active --quiet 3proxy; then
    echo "‚úÖ 3proxy: Running"
else
    echo "‚ùå 3proxy: Not running"
fi

# Check listening
echo ""
echo "[3] Listening ports:"
ss -tuln | grep ":${FIRST_PORT}" 2>/dev/null | head -5

# Test proxy
echo ""
echo "[4] Testing actual proxy..."
TEST_PROXY=$(head -1 proxy.txt)
echo "Proxy: ${TEST_PROXY}"

PROXY_WORKS=0
for i in {1..5}; do
    TEST_RESULT=$(timeout 20 curl -x socks5://${TEST_PROXY} -s https://api.ipify.org 2>/dev/null)
    
    if [ -n "$TEST_RESULT" ]; then
        echo "‚úÖ Attempt $i: IP = ${TEST_RESULT}"
        
        if [ "$TEST_RESULT" != "$IP4" ]; then
            echo "   üéâ IP differs from VPS ‚Üí Traffic via Cloudflare!"
        else
            echo "   ‚ÑπÔ∏è  IP = VPS ‚Üí Proxy working but not via WARP"
        fi
        
        PROXY_WORKS=1
        break
    else
        if [ $i -lt 5 ]; then
            echo "‚è≥ Attempt $i timeout, retrying..."
            sleep 5
        else
            echo "‚ùå Timeout after 5 attempts"
        fi
    fi
done

# ================================================================
# K·∫æT LU·∫¨N
# ================================================================

echo ""
echo "============================================"
echo "  RESULT"
echo "============================================"

if [ $PROXY_WORKS -eq 1 ]; then
    echo "‚úÖ SUCCESS! Proxy is working"
    if [ $WARP_STATUS -eq 0 ]; then
        echo "   WITH Cloudflare WARP layer"
    else
        echo "   WITHOUT WARP layer"
    fi
else
    echo "‚ö†Ô∏è  ISSUE! Proxy not working"
    echo ""
    echo "DEBUG STEPS:"
    echo "1. Check 3proxy logs:"
    echo "   cat /usr/local/etc/3proxy/logs/3proxy.log"
    echo "   journalctl -u 3proxy -n 50"
    echo ""
    echo "2. Test WARP directly:"
    echo "   curl -x socks5://127.0.0.1:40000 https://api.ipify.org"
    echo ""
    echo "3. Test without WARP:"
    echo "   Recreate config without WARP and restart 3proxy"
fi

echo ""
echo "Proxy file: ${WORKDIR}/proxy.txt"
echo "‚úÖ Script completed!"

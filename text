#!/bin/bash
# ================================================================
# Script: 3proxy + Cloudflare WARP (FIXED VERSION)
# Version: 6.0 - Fixed network connectivity
# ================================================================

if [ "$(id -u)" != "0" ]; then
    echo "‚ùå Script n√†y c·∫ßn ch·∫°y v·ªõi quy·ªÅn root" 1>&2
    exit 1
fi

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${GREEN}============================================${NC}"
echo -e "${GREEN}  3proxy + WARP v6.0 (FIXED)${NC}"
echo -e "${GREEN}============================================${NC}"

echo -e "\n${YELLOW}‚ö†Ô∏è  Script s·∫Ω:${NC}"
echo -e "${YELLOW}1. C√†i ƒë·∫∑t t·∫•t c·∫£ g√≥i c·∫ßn thi·∫øt${NC}"
echo -e "${YELLOW}2. C√†i ƒë·∫∑t v√† c·∫•u h√¨nh WARP${NC}"
echo -e "${YELLOW}3. T·∫°o IPv6 interfaces${NC}"
echo -e "${YELLOW}4. C·∫•u h√¨nh 3proxy ƒëi qua WARP${NC}"
echo -e "${YELLOW}5. Thi·∫øt l·∫≠p firewall ƒë·∫ßy ƒë·ªß${NC}"
echo -e "\n${BLUE}Nh·∫•n Enter ƒë·ªÉ ti·∫øp t·ª•c...${NC}"
read

# ================================================================
# H√ÄM TI·ªÜN √çCH
# ================================================================

random() {
    tr </dev/urandom -dc A-Za-z0-9 | head -c8
    echo
}

array=(1 2 3 4 5 6 7 8 9 0 a b c d e f)
gen64() {
    ip64() {
        echo "${array[$RANDOM % 16]}${array[$RANDOM % 16]}${array[$RANDOM % 16]}${array[$RANDOM % 16]}"
    }
    echo "$1:$(ip64):$(ip64):$(ip64):$(ip64)"
}

# ================================================================
# C√ÄI ƒê·∫∂T G√ìI
# ================================================================

install_packages() {
    echo -e "\n${YELLOW}[1/10] C√†i ƒë·∫∑t c√°c g√≥i c·∫ßn thi·∫øt...${NC}"
    
    if [ -f /etc/redhat-release ]; then
        yum -y install gcc net-tools bsdtar zip curl expect nc >/dev/null 2>&1
    else
        apt-get update -qq
        apt-get install -y gcc net-tools bsdtar zip curl expect netcat >/dev/null 2>&1
    fi
    
    echo -e "${GREEN}‚úÖ Ho√†n t·∫•t c√†i ƒë·∫∑t g√≥i${NC}"
}

# ================================================================
# C√ÄI ƒê·∫∂T CLOUDFLARE WARP
# ================================================================

install_cloudflare_warp() {
    echo -e "\n${YELLOW}[2/10] C√†i ƒë·∫∑t Cloudflare WARP...${NC}"
    
    if [ -f /etc/redhat-release ]; then
        curl -fsSL https://pkg.cloudflareclient.com/cloudflare-warp-ascii.repo | tee /etc/yum.repos.d/cloudflare-warp.repo >/dev/null
        yum install -y cloudflare-warp >/dev/null 2>&1
    else
        curl -fsSL https://pkg.cloudflareclient.com/pubkey.gpg | gpg --dearmor -o /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg 2>/dev/null
        echo "deb [arch=amd64 signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] https://pkg.cloudflareclient.com/ $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/cloudflare-client.list >/dev/null
        apt-get update -qq
        apt-get install -y cloudflare-warp >/dev/null 2>&1
    fi
    
    echo -e "${GREEN}‚úÖ Ho√†n t·∫•t c√†i ƒë·∫∑t WARP${NC}"
}

configure_cloudflare_warp() {
    echo -e "\n${YELLOW}[3/10] C·∫•u h√¨nh Cloudflare WARP...${NC}"
    
    # Kh·ªüi ƒë·ªông service
    echo -e "${BLUE}‚Üí Kh·ªüi ƒë·ªông warp-svc...${NC}"
    systemctl enable warp-svc >/dev/null 2>&1
    systemctl restart warp-svc
    sleep 5
    
    # X√≥a registration c≈©
    echo -e "${BLUE}‚Üí Reset WARP...${NC}"
    warp-cli disconnect >/dev/null 2>&1
    warp-cli registration delete >/dev/null 2>&1
    sleep 2
    
    # ƒêƒÉng k√Ω m·ªõi
    echo -e "${BLUE}‚Üí ƒêƒÉng k√Ω WARP...${NC}"
    echo -e "y\ny\ny" | warp-cli registration new >/dev/null 2>&1
    sleep 3
    
    # ƒê·∫∑t ch·∫ø ƒë·ªô proxy
    echo -e "${BLUE}‚Üí ƒê·∫∑t ch·∫ø ƒë·ªô PROXY...${NC}"
    warp-cli mode proxy >/dev/null 2>&1
    sleep 2
    
    # K·∫øt n·ªëi WARP
    echo -e "${BLUE}‚Üí K·∫øt n·ªëi WARP (ƒë·ª£i 15 gi√¢y)...${NC}"
    warp-cli connect >/dev/null 2>&1
    sleep 15
    
    # Ki·ªÉm tra port 40000
    echo -e "${BLUE}‚Üí Ki·ªÉm tra WARP proxy...${NC}"
    for i in {1..15}; do
        if netstat -tuln 2>/dev/null | grep -q ":40000" || ss -tuln 2>/dev/null | grep -q ":40000"; then
            echo -e "${GREEN}‚úÖ WARP Proxy ƒë√£ s·∫µn s√†ng (port 40000)${NC}"
            
            # Test IP qua WARP
            WARP_IP=$(curl -x socks5://127.0.0.1:40000 -s --connect-timeout 10 https://api.ipify.org 2>/dev/null)
            if [ -n "$WARP_IP" ]; then
                echo -e "${GREEN}‚úÖ IP qua WARP: ${WARP_IP}${NC}"
            fi
            
            return 0
        fi
        
        echo -e "${YELLOW}   ƒê·ª£i WARP proxy... ($i/15)${NC}"
        sleep 2
    done
    
    echo -e "${RED}‚ùå WARP proxy kh√¥ng kh·ªüi ƒë·ªông ƒë∆∞·ª£c port 40000${NC}"
    echo -e "${YELLOW}‚ö†Ô∏è  Proxy s·∫Ω KH√îNG ƒëi qua Cloudflare${NC}"
    return 1
}

# ================================================================
# C√ÄI ƒê·∫∂T 3PROXY
# ================================================================

install_3proxy() {
    echo -e "\n${YELLOW}[4/10] C√†i ƒë·∫∑t 3proxy...${NC}"
    
    URL="https://raw.githubusercontent.com/quayvlog/quayvlog/main/3proxy-3proxy-0.8.6.tar.gz"
    wget -qO- $URL | bsdtar -xvf- >/dev/null 2>&1
    cd 3proxy-3proxy-0.8.6
    make -f Makefile.Linux >/dev/null 2>&1
    mkdir -p /usr/local/etc/3proxy/{bin,logs,stat}
    cp src/3proxy /usr/local/etc/3proxy/bin/
    cd $WORKDIR
    
    echo -e "${GREEN}‚úÖ Ho√†n t·∫•t c√†i ƒë·∫∑t 3proxy${NC}"
}

# ================================================================
# T·∫†O C·∫§U H√åNH 3PROXY (QUAN TR·ªåNG - ƒê√É S·ª¨A)
# ================================================================

gen_3proxy() {
    cat <<EOF
daemon
maxconn 2000
nscache 65535
timeouts 1 5 30 60 180 1800 15 60
setgid 65535
setuid 65535
flush
auth strong

users $(awk -F "/" 'BEGIN{ORS="";} {print $1 ":CL:" $2 " "}' ${WORKDATA})

$(awk -F "/" '{print "auth strong\n" \
"allow " $1 "\n" \
"proxy -6 -n -a -p" $4 " -i" $3 " -e"$5 "\n" \
"flush\n"}' ${WORKDATA})
EOF
}

# N·∫øu WARP ho·∫°t ƒë·ªông, th√™m parent proxy
gen_3proxy_with_warp() {
    cat <<EOF
daemon
maxconn 2000
nscache 65535
timeouts 1 5 30 60 180 1800 15 60
setgid 65535
setuid 65535
flush

# WARP Parent Proxy
parent 1000 socks5 127.0.0.1 40000

auth strong

users $(awk -F "/" 'BEGIN{ORS="";} {print $1 ":CL:" $2 " "}' ${WORKDATA})

$(awk -F "/" '{print "auth strong\n" \
"allow " $1 "\n" \
"parent 1000\n" \
"proxy -6 -n -a -p" $4 " -i" $3 " -e"$5 "\n" \
"flush\n"}' ${WORKDATA})
EOF
}

gen_proxy_file_for_user() {
    cat >proxy.txt <<EOF
$(awk -F "/" '{print $3 ":" $4 ":" $1 ":" $2 }' ${WORKDATA})
EOF
}

gen_data() {
    seq $FIRST_PORT $LAST_PORT | while read port; do
        echo "usr$(random)/pass$(random)/$IP4/$port/$(gen64 $IP6)"
    done
}

gen_iptables() {
    cat <<EOF
$(awk -F "/" '{print "iptables -I INPUT -p tcp --dport " $4 " -m state --state NEW -j ACCEPT"}' ${WORKDATA})
EOF
}

gen_ifconfig() {
    # T·ª± ƒë·ªông ph√°t hi·ªán network interface
    IFACE=$(ip -6 route show default | awk '{print $5; exit}')
    if [ -z "$IFACE" ]; then
        IFACE="eth0"
    fi
    
    cat <<EOF
$(awk -F "/" -v iface="$IFACE" '{print "ip -6 addr add " $5 "/64 dev " iface}' ${WORKDATA})
EOF
}

# ================================================================
# MAIN EXECUTION
# ================================================================

install_packages
install_cloudflare_warp
WARP_STATUS=$?
configure_cloudflare_warp
WARP_READY=$?

install_3proxy

echo -e "\n${YELLOW}[5/10] Thi·∫øt l·∫≠p th√¥ng tin VPS...${NC}"
WORKDIR="/home/proxy-installer"
WORKDATA="${WORKDIR}/data.txt"
mkdir -p $WORKDIR && cd $_

IP4=$(curl -4 -s icanhazip.com)
IP6=$(curl -6 -s icanhazip.com | cut -f1-4 -d':')

echo -e "${BLUE}VPS IPv4: ${GREEN}${IP4}${NC}"
echo -e "${BLUE}VPS IPv6: ${GREEN}${IP6}${NC}"

echo -e "\n${YELLOW}Nh·∫≠p s·ªë l∆∞·ª£ng proxy c·∫ßn t·∫°o (v√≠ d·ª•: 200):${NC}"
read COUNT

FIRST_PORT=10000
LAST_PORT=$(($FIRST_PORT + $COUNT - 1))

echo -e "\n${YELLOW}[6/10] T·∫°o d·ªØ li·ªáu proxy...${NC}"
gen_data >$WORKDIR/data.txt
gen_iptables >$WORKDIR/boot_iptables.sh
gen_ifconfig >$WORKDIR/boot_ifconfig.sh
chmod +x ${WORKDIR}/boot_*.sh

# Ch·ªçn c·∫•u h√¨nh 3proxy d·ª±a tr√™n WARP
if [ $WARP_READY -eq 0 ]; then
    echo -e "${GREEN}‚úÖ S·ª≠ d·ª•ng c·∫•u h√¨nh 3proxy + WARP${NC}"
    gen_3proxy_with_warp >/usr/local/etc/3proxy/3proxy.cfg
else
    echo -e "${YELLOW}‚ö†Ô∏è  S·ª≠ d·ª•ng c·∫•u h√¨nh 3proxy KH√îNG c√≥ WARP${NC}"
    gen_3proxy >/usr/local/etc/3proxy/3proxy.cfg
fi

echo "* soft nofile 65535" >> /etc/security/limits.conf
echo "* hard nofile 65535" >> /etc/security/limits.conf
echo "session required pam_limits.so" >> /etc/pam.d/common-session 2>/dev/null

echo -e "${GREEN}‚úÖ Ho√†n t·∫•t t·∫°o c·∫•u h√¨nh${NC}"

# ================================================================
# T·∫†O SYSTEMD SERVICES
# ================================================================

echo -e "\n${YELLOW}[7/10] T·∫°o systemd services...${NC}"

# WARP Service
cat >/etc/systemd/system/cloudflare-warp-proxy.service <<EOF
[Unit]
Description=Cloudflare WARP Proxy Mode
Before=3proxy.service
After=network.target warp-svc.service
Requires=warp-svc.service

[Service]
Type=oneshot
ExecStart=/usr/bin/warp-cli mode proxy
ExecStartPost=/bin/sleep 3
ExecStartPost=/usr/bin/warp-cli connect
RemainAfterExit=yes
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# 3proxy Service
cat >/etc/systemd/system/3proxy.service <<EOF
[Unit]
Description=3proxy tiny proxy server
After=network.target cloudflare-warp-proxy.service
Wants=cloudflare-warp-proxy.service

[Service]
Type=forking
ExecStart=/usr/local/etc/3proxy/bin/3proxy /usr/local/etc/3proxy/3proxy.cfg
ExecStop=/bin/kill -TERM \$MAINPID
RemainAfterExit=yes
Restart=always
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable warp-svc >/dev/null 2>&1
systemctl enable cloudflare-warp-proxy.service >/dev/null 2>&1
systemctl enable 3proxy >/dev/null 2>&1

echo -e "${GREEN}‚úÖ Ho√†n t·∫•t t·∫°o services${NC}"

# ================================================================
# THI·∫æT L·∫¨P IPV6 INTERFACES (QUAN TR·ªåNG)
# ================================================================

echo -e "\n${YELLOW}[8/10] Thi·∫øt l·∫≠p IPv6 interfaces...${NC}"
bash ${WORKDIR}/boot_ifconfig.sh
echo -e "${GREEN}‚úÖ ƒê√£ th√™m $(wc -l < ${WORKDIR}/boot_ifconfig.sh) ƒë·ªãa ch·ªâ IPv6${NC}"

# ================================================================
# THI·∫æT L·∫¨P FIREWALL (QUAN TR·ªåNG)
# ================================================================

echo -e "\n${YELLOW}[9/10] Thi·∫øt l·∫≠p firewall...${NC}"

# Ch·∫°y iptables rules
bash ${WORKDIR}/boot_iptables.sh

# Firewalld (n·∫øu c√≥)
if command -v firewall-cmd >/dev/null 2>&1; then
    echo -e "${BLUE}‚Üí C·∫•u h√¨nh firewalld...${NC}"
    for port in $(seq $FIRST_PORT $LAST_PORT); do
        firewall-cmd --permanent --add-port=${port}/tcp >/dev/null 2>&1
    done
    firewall-cmd --reload >/dev/null 2>&1
    echo -e "${GREEN}‚úÖ Firewalld ƒë√£ ƒë∆∞·ª£c c·∫•u h√¨nh${NC}"
fi

# UFW (n·∫øu c√≥)
if command -v ufw >/dev/null 2>&1; then
    echo -e "${BLUE}‚Üí C·∫•u h√¨nh UFW...${NC}"
    for port in $(seq $FIRST_PORT $LAST_PORT); do
        ufw allow ${port}/tcp >/dev/null 2>&1
    done
    ufw reload >/dev/null 2>&1
    echo -e "${GREEN}‚úÖ UFW ƒë√£ ƒë∆∞·ª£c c·∫•u h√¨nh${NC}"
fi

echo -e "${GREEN}‚úÖ Ho√†n t·∫•t thi·∫øt l·∫≠p firewall${NC}"

# ================================================================
# KH·ªûI ƒê·ªòNG SERVICES
# ================================================================

echo -e "\n${YELLOW}[10/10] Kh·ªüi ƒë·ªông services...${NC}"

if [ $WARP_READY -eq 0 ]; then
    systemctl start cloudflare-warp-proxy.service
    sleep 5
fi

systemctl start 3proxy
sleep 3

# ================================================================
# T·∫†O FILE PROXY
# ================================================================

gen_proxy_file_for_user

echo -e "\n${GREEN}============================================${NC}"
echo -e "${GREEN}  ‚úÖ PROXY ƒê√É S·∫¥N S√ÄNG!${NC}"
echo -e "${GREEN}============================================${NC}"
echo -e "${BLUE}Format: IP:PORT:USER:PASS${NC}"
echo -e "${YELLOW}File: ${WORKDIR}/proxy.txt${NC}\n"

head -10 proxy.txt
TOTAL=$(wc -l < proxy.txt)
if [ $TOTAL -gt 10 ]; then
    echo -e "\n${BLUE}... v√† $((TOTAL - 10)) proxy kh√°c${NC}"
fi

# ================================================================
# KI·ªÇM TRA TO√ÄN DI·ªÜN
# ================================================================

echo -e "\n${GREEN}============================================${NC}"
echo -e "${GREEN}  KI·ªÇM TRA H·ªÜ TH·ªêNG${NC}"
echo -e "${GREEN}============================================${NC}"

# Ki·ªÉm tra 3proxy
echo -e "\n${YELLOW}[1] Tr·∫°ng th√°i 3proxy:${NC}"
if systemctl is-active --quiet 3proxy; then
    echo -e "${GREEN}‚úÖ 3proxy ƒëang ch·∫°y${NC}"
else
    echo -e "${RED}‚ùå 3proxy kh√¥ng ch·∫°y${NC}"
    echo -e "${YELLOW}Debug: journalctl -u 3proxy -n 50${NC}"
fi

# Ki·ªÉm tra WARP
echo -e "\n${YELLOW}[2] Tr·∫°ng th√°i WARP:${NC}"
if netstat -tuln 2>/dev/null | grep -q ":40000" || ss -tuln 2>/dev/null | grep -q ":40000"; then
    echo -e "${GREEN}‚úÖ WARP Proxy ho·∫°t ƒë·ªông (port 40000)${NC}"
    
    WARP_TEST_IP=$(curl -x socks5://127.0.0.1:40000 -s --connect-timeout 10 https://api.ipify.org 2>/dev/null)
    if [ -n "$WARP_TEST_IP" ]; then
        echo -e "${GREEN}   IP qua WARP: ${WARP_TEST_IP}${NC}"
    fi
else
    echo -e "${RED}‚ùå WARP Proxy kh√¥ng ho·∫°t ƒë·ªông${NC}"
fi

# Ki·ªÉm tra listening ports
echo -e "\n${YELLOW}[3] Ki·ªÉm tra listening ports:${NC}"
LISTENING_COUNT=$(ss -tuln 2>/dev/null | grep -c ":${FIRST_PORT}" || netstat -tuln 2>/dev/null | grep -c ":${FIRST_PORT}")
if [ $LISTENING_COUNT -gt 0 ]; then
    echo -e "${GREEN}‚úÖ Port ${FIRST_PORT} ƒëang listen${NC}"
else
    echo -e "${RED}‚ùå Port ${FIRST_PORT} KH√îNG listen${NC}"
fi

# Ki·ªÉm tra IPv6 interfaces
echo -e "\n${YELLOW}[4] Ki·ªÉm tra IPv6 interfaces:${NC}"
IPV6_COUNT=$(ip -6 addr show | grep -c "inet6 ${IP6}")
if [ $IPV6_COUNT -gt 0 ]; then
    echo -e "${GREEN}‚úÖ ƒê√£ th√™m ${IPV6_COUNT} ƒë·ªãa ch·ªâ IPv6${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è  Ch∆∞a th·∫•y IPv6 interfaces (c√≥ th·ªÉ c·∫ßn reboot)${NC}"
fi

# Test proxy th·ª±c t·∫ø
echo -e "\n${YELLOW}[5] Test proxy th·ª±c t·∫ø:${NC}"
TEST_PROXY=$(head -1 proxy.txt)
echo -e "${BLUE}Proxy: ${TEST_PROXY}${NC}"

# Th·ª≠ 5 l·∫ßn
for i in {1..5}; do
    TEST_RESULT=$(timeout 20 curl -x socks5://${TEST_PROXY} -s https://api.ipify.org 2>/dev/null)
    
    if [ -n "$TEST_RESULT" ]; then
        echo -e "${GREEN}‚úÖ L·∫ßn $i: IP = ${TEST_RESULT}${NC}"
        
        if [ "$TEST_RESULT" != "$IP4" ]; then
            echo -e "${GREEN}   üéâ IP kh√°c VPS ‚Üí Proxy ƒëang qua Cloudflare!${NC}"
        else
            echo -e "${YELLOW}   ‚ÑπÔ∏è  IP = VPS ‚Üí Proxy ho·∫°t ƒë·ªông nh∆∞ng ch∆∞a qua Cloudflare${NC}"
        fi
        
        PROXY_WORKS=true
        break
    else
        if [ $i -lt 5 ]; then
            echo -e "${YELLOW}‚è≥ L·∫ßn $i timeout, th·ª≠ l·∫°i...${NC}"
            sleep 5
        else
            echo -e "${RED}‚ùå Timeout sau 5 l·∫ßn th·ª≠${NC}"
            PROXY_WORKS=false
        fi
    fi
done

# Test k·∫øt n·ªëi ports
echo -e "\n${YELLOW}[6] Test k·∫øt n·ªëi ports (ki·ªÉm tra 5 port ƒë·∫ßu):${NC}"
for port in $(seq $FIRST_PORT $(($FIRST_PORT + 4))); do
    if timeout 2 bash -c "echo > /dev/tcp/127.0.0.1/$port" 2>/dev/null; then
        echo -e "${GREEN}‚úÖ Port $port: Accessible${NC}"
    else
        echo -e "${RED}‚ùå Port $port: Not accessible${NC}"
    fi
done

# ================================================================
# K·∫æT LU·∫¨N V√Ä H∆Ø·ªöNG D·∫™N
# ================================================================

echo -e "\n${GREEN}============================================${NC}"
echo -e "${GREEN}  K·∫æT QU·∫¢ CU·ªêI C√ôNG${NC}"
echo -e "${GREEN}============================================${NC}"

if [ "$PROXY_WORKS" = true ]; then
    echo -e "${GREEN}‚úÖ TH√ÄNH C√îNG! Proxy ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng${NC}"
    echo -e "${GREEN}   File proxy: ${WORKDIR}/proxy.txt${NC}"
    
    if [ $WARP_READY -eq 0 ]; then
        echo -e "${GREEN}   Proxy ƒëi qua Cloudflare WARP${NC}"
    else
        echo -e "${YELLOW}   Proxy ho·∫°t ƒë·ªông KH√îNG qua WARP${NC}"
    fi
else
    echo -e "${YELLOW}‚ö†Ô∏è  C√ì V·∫§N ƒê·ªÄ! Proxy kh√¥ng test th√†nh c√¥ng${NC}"
    echo -e "\n${BLUE}KH·∫ÆC PH·ª§C:${NC}"
    echo -e "${BLUE}1. Ki·ªÉm tra logs:${NC}"
    echo -e "   journalctl -u 3proxy -n 100"
    echo -e "   cat /usr/local/etc/3proxy/logs/3proxy.log"
    echo -e "\n${BLUE}2. Ki·ªÉm tra c·∫•u h√¨nh:${NC}"
    echo -e "   cat /usr/local/etc/3proxy/3proxy.cfg"
    echo -e "\n${BLUE}3. Ki·ªÉm tra IPv6:${NC}"
    echo -e "   ip -6 addr show | grep ${IP6}"
    echo -e "\n${BLUE}4. Kh·ªüi ƒë·ªông l·∫°i services:${NC}"
    echo -e "   systemctl restart 3proxy"
    echo -e "   systemctl restart warp-svc"
    echo -e "   warp-cli connect"
fi

# T·∫°o file h∆∞·ªõng d·∫´n
cat > ${WORKDIR}/HUONG-DAN.txt <<EOF
============================================
  H∆Ø·ªöNG D·∫™N S·ª¨ D·ª§NG PROXY
============================================

FILE PROXY: ${WORKDIR}/proxy.txt
S·ªê L∆Ø·ª¢NG: ${COUNT} proxy
C·ªîNG: ${FIRST_PORT} - ${LAST_PORT}
FORMAT: IP:PORT:USER:PASS

C·∫§U TR√öC:
  Client ‚Üí 3proxy (${IP4}:${FIRST_PORT}+)
         ‚Üí IPv6 (${IP6}:xxxx)
         $([ $WARP_READY -eq 0 ] && echo "‚Üí WARP Proxy (127.0.0.1:40000)" || echo "")
         $([ $WARP_READY -eq 0 ] && echo "‚Üí Cloudflare" || echo "")
         ‚Üí Internet

KI·ªÇM TRA:

1. Tr·∫°ng th√°i services:
   systemctl status 3proxy
   systemctl status warp-svc

2. Test proxy:
   curl -x socks5://${TEST_PROXY} https://api.ipify.org
   (IP ph·∫£i kh√°c ${IP4} n·∫øu c√≥ WARP)

3. Ki·ªÉm tra logs:
   journalctl -u 3proxy -f
   cat /usr/local/etc/3proxy/logs/3proxy.log

4. Ki·ªÉm tra port ƒëang listen:
   ss -tuln | grep ${FIRST_PORT}
   netstat -tuln | grep ${FIRST_PORT}

5. Ki·ªÉm tra IPv6:
   ip -6 addr show | grep ${IP6}

KH·∫ÆC PH·ª§C N·∫æU PROXY KH√îNG HO·∫†T ƒê·ªòNG:

A. N·∫øu WARP kh√¥ng ho·∫°t ƒë·ªông:
   systemctl restart warp-svc
   sleep 5
   warp-cli registration delete
   warp-cli registration new
   warp-cli mode proxy
   warp-cli connect
   sleep 10
   netstat -tuln | grep 40000

B. N·∫øu 3proxy kh√¥ng ho·∫°t ƒë·ªông:
   systemctl stop 3proxy
   /usr/local/etc/3proxy/bin/3proxy /usr/local/etc/3proxy/3proxy.cfg
   (Xem l·ªói tr·ª±c ti·∫øp)

C. N·∫øu IPv6 kh√¥ng ho·∫°t ƒë·ªông:
   bash ${WORKDIR}/boot_ifconfig.sh
   ip -6 addr show

D. N·∫øu firewall ch·∫∑n:
   bash ${WORKDIR}/boot_iptables.sh
   firewall-cmd --list-all
   iptables -L -n | grep ${FIRST_PORT}

REBOOT SERVER:
   Sau khi reboot, c·∫ßn ch·∫°y l·∫°i:
   bash ${WORKDIR}/boot_ifconfig.sh
   systemctl start warp-svc
   warp-cli connect
   systemctl start 3proxy

LI√äN H·ªÜ H·ªñ TR·ª¢:
   - Logs 3proxy: /usr/local/etc/3proxy/logs/
   - Config 3proxy: /usr/local/etc/3proxy/3proxy.cfg
   - Data: ${WORKDIR}/data.txt

============================================
EOF

echo -e "\n${BLUE}üìñ H∆∞·ªõng d·∫´n chi ti·∫øt: ${WORKDIR}/HUONG-DAN.txt${NC}"
echo -e "${GREEN}‚úÖ Script ƒë√£ ho√†n t·∫•t!${NC}\n"

# Logs cu·ªëi c√πng
echo -e "${YELLOW}M·ªôt s·ªë l·ªánh h·ªØu √≠ch:${NC}"
echo -e "  ${BLUE}systemctl status 3proxy${NC}       - Tr·∫°ng th√°i 3proxy"
echo -e "  ${BLUE}journalctl -u 3proxy -f${NC}       - Logs 3proxy real-time"
echo -e "  ${BLUE}warp-cli status${NC}                - Tr·∫°ng th√°i WARP"
echo -e "  ${BLUE}cat ${WORKDIR}/proxy.txt${NC}      - Xem danh s√°ch proxy"
echo -e "  ${BLUE}cat ${WORKDIR}/HUONG-DAN.txt${NC}  - Xem h∆∞·ªõng d·∫´n ƒë·∫ßy ƒë·ªß\n"

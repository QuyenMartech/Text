#!/bin/bash

# Kiểm tra quyền root
if [ "$(id -u)" != "0" ]; then
    echo "❌ Script phải chạy với quyền root"
    echo "Chạy lệnh: sudo bash script.sh"
    exit 1
fi

# Màu sắc
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${GREEN}============================================${NC}"
echo -e "${GREEN}  3proxy + Cloudflare WARP Setup v3.0${NC}"
echo -e "${GREEN}============================================${NC}"

# ================================================================
# PHẦN 1: CÀI ĐẶT CLOUDFLARE WARP
# ================================================================

install_cloudflare_warp() {
    echo -e "\n${YELLOW}[1/8] Cài đặt Cloudflare WARP...${NC}"
    
    if [ -f /etc/redhat-release ]; then
        echo -e "${BLUE}Hệ điều hành: CentOS/RHEL${NC}"
        curl -fsSL https://pkg.cloudflareclient.com/cloudflare-warp-ascii.repo | tee /etc/yum.repos.d/cloudflare-warp.repo >/dev/null
        yum install -y cloudflare-warp >/dev/null 2>&1
    elif [ -f /etc/debian_version ]; then
        echo -e "${BLUE}Hệ điều hành: Debian/Ubuntu${NC}"
        curl -fsSL https://pkg.cloudflareclient.com/pubkey.gpg | gpg --dearmor -o /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg
        echo "deb [arch=amd64 signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] https://pkg.cloudflareclient.com/ $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/cloudflare-client.list
        apt-get update -qq
        apt-get install -y cloudflare-warp >/dev/null 2>&1
    else
        echo -e "${RED}❌ Hệ điều hành không được hỗ trợ${NC}"
        exit 1
    fi
    
    echo -e "${GREEN}✅ Đã cài đặt Cloudflare WARP${NC}"
}

configure_cloudflare_warp() {
    echo -e "\n${YELLOW}[2/8] Cấu hình Cloudflare WARP...${NC}"
    
    # Khởi động dịch vụ
    echo -e "${BLUE}Khởi động warp-svc...${NC}"
    systemctl enable warp-svc >/dev/null 2>&1
    systemctl restart warp-svc
    sleep 5
    
    # Xóa registration cũ
    warp-cli registration delete >/dev/null 2>&1
    sleep 2
    
    # ================================================================
    # CÁCH ĐÚNG: Sử dụng 'registration new' với 'yes'
    # ================================================================
    echo -e "${BLUE}Đăng ký WARP (tự động chấp nhận TOS)...${NC}"
    
    # Tạo script expect để tự động trả lời 'y'
    cat > /tmp/warp-register.exp <<'EXPECT_SCRIPT'
#!/usr/bin/expect -f
set timeout 30
spawn warp-cli registration new
expect {
    "Accept*?" { send "y\r"; exp_continue }
    "y/N" { send "y\r"; exp_continue }
    "Success" { exit 0 }
    timeout { exit 1 }
    eof
}
EXPECT_SCRIPT
    
    chmod +x /tmp/warp-register.exp
    
    # Chạy expect script
    if command -v expect >/dev/null 2>&1; then
        /tmp/warp-register.exp 2>/dev/null
    else
        # Nếu không có expect, dùng echo piping
        echo -e "y\ny\ny" | warp-cli registration new 2>/dev/null
    fi
    
    REGISTER_EXIT=$?
    rm -f /tmp/warp-register.exp
    
    sleep 3
    
    # Kiểm tra đăng ký
    REG_STATUS=$(warp-cli registration show 2>&1)
    
    if echo "$REG_STATUS" | grep -qi "Created\|Active\|Device ID"; then
        echo -e "${GREEN}✅ Đăng ký WARP thành công${NC}"
    else
        echo -e "${YELLOW}⚠️  Thử phương pháp thay thế...${NC}"
        
        # Phương pháp 2: Sử dụng timeout với yes
        timeout 20 bash -c 'yes y | warp-cli registration new' 2>/dev/null
        sleep 3
        
        REG_STATUS=$(warp-cli registration show 2>&1)
        if ! echo "$REG_STATUS" | grep -qi "Created\|Active\|Device ID"; then
            echo -e "${YELLOW}⚠️  Thử phương pháp 3...${NC}"
            
            # Phương pháp 3: Interactive với stdin
            printf "y\ny\n" | warp-cli registration new 2>/dev/null
            sleep 3
        fi
    fi
    
    # ================================================================
    # Đặt chế độ WARP
    # ================================================================
    echo -e "${BLUE}Cấu hình chế độ WARP...${NC}"
    warp-cli mode warp 2>/dev/null
    sleep 2
    
    # ================================================================
    # Kết nối WARP
    # ================================================================
    echo -e "${BLUE}Kết nối Cloudflare WARP...${NC}"
    warp-cli connect 2>/dev/null
    sleep 10
    
    # Kiểm tra kết nối nhiều lần
    MAX_RETRIES=5
    for i in $(seq 1 $MAX_RETRIES); do
        WARP_STATUS=$(warp-cli status 2>&1)
        
        if echo "$WARP_STATUS" | grep -qi "Connected"; then
            echo -e "${GREEN}✅ WARP đã kết nối (lần thử $i)${NC}"
            break
        elif echo "$WARP_STATUS" | grep -qi "Connecting"; then
            echo -e "${YELLOW}⏳ WARP đang kết nối... (lần $i/$MAX_RETRIES)${NC}"
            sleep 5
        else
            echo -e "${YELLOW}⚠️  Trạng thái: $(echo $WARP_STATUS | head -1)${NC}"
            
            if [ $i -lt $MAX_RETRIES ]; then
                echo -e "${YELLOW}Thử kết nối lại...${NC}"
                warp-cli disconnect 2>/dev/null
                sleep 3
                warp-cli connect 2>/dev/null
                sleep 8
            fi
        fi
    done
    
    # Kiểm tra cuối cùng
    if warp-cli status 2>&1 | grep -qi "Connected"; then
        echo -e "${GREEN}✅ Cloudflare WARP đã sẵn sàng${NC}"
        
        # Lấy IP qua WARP
        sleep 3
        WARP_IP=$(curl -4 -s --connect-timeout 10 icanhazip.com 2>/dev/null || echo "N/A")
        echo -e "${BLUE}IP qua WARP: ${GREEN}${WARP_IP}${NC}"
        
        # Kiểm tra xem có phải IP Cloudflare không
        if [ "$WARP_IP" != "N/A" ]; then
            ORG=$(curl -s "https://ipinfo.io/${WARP_IP}/org" 2>/dev/null)
            if echo "$ORG" | grep -qi "cloudflare"; then
                echo -e "${GREEN}✅ Xác nhận: Đang sử dụng Cloudflare${NC}"
            fi
        fi
    else
        echo -e "${RED}❌ WARP không kết nối được sau $MAX_RETRIES lần thử${NC}"
        echo -e "${YELLOW}Script sẽ tiếp tục, bạn có thể sửa WARP sau${NC}"
    fi
}

# ================================================================
# PHẦN 2: HÀM GỐC
# ================================================================

random() {
    tr </dev/urandom -dc A-Za-z0-9 | head -c8
    echo
}

array=(1 2 3 4 5 6 7 8 9 0 a b c d e f)
gen64() {
    ip64() {
        echo "${array[$RANDOM % 16]}${array[$RANDOM % 16]}${array[$RANDOM % 16]}${array[$RANDOM % 16]}"
    }
    echo "$1:$(ip64):$(ip64):$(ip64):$(ip64)"
}

install_3proxy() {
    echo -e "\n${YELLOW}[3/8] Cài đặt 3proxy...${NC}"
    URL="https://raw.githubusercontent.com/quayvlog/quayvlog/main/3proxy-3proxy-0.8.6.tar.gz"
    wget -qO- $URL | bsdtar -xvf- >/dev/null 2>&1
    cd 3proxy-3proxy-0.8.6
    make -f Makefile.Linux >/dev/null 2>&1
    mkdir -p /usr/local/etc/3proxy/{bin,logs,stat}
    cp src/3proxy /usr/local/etc/3proxy/bin/
    cd $WORKDIR
    echo -e "${GREEN}✅ Đã cài đặt 3proxy${NC}"
}

gen_3proxy() {
    cat <<EOF
daemon
maxconn 2000
nscache 65535
timeouts 1 5 30 60 180 1800 15 60
setgid 65535
setuid 65535
flush
auth strong

users $(awk -F "/" 'BEGIN{ORS="";} {print $1 ":CL:" $2 " "}' ${WORKDATA})

$(awk -F "/" '{print "auth strong\nallow " $1 "\nproxy -6 -n -a -p" $4 " -i" $3 " -e"$5 "\nflush\n"}' ${WORKDATA})
EOF
}

gen_proxy_file_for_user() {
    cat >proxy.txt <<EOF
$(awk -F "/" '{print $3 ":" $4 ":" $1 ":" $2 }' ${WORKDATA})
EOF
}

print_proxy() {
    echo -e "\n${GREEN}============================================${NC}"
    echo -e "${GREEN}  ✅ PROXY ĐÃ SẴN SÀNG!${NC}"
    echo -e "${GREEN}============================================${NC}"
    echo -e "${BLUE}Format: IP:PORT:USERNAME:PASSWORD${NC}"
    echo -e "${YELLOW}File: ${WORKDIR}/proxy.txt${NC}\n"
    head -10 proxy.txt
    TOTAL=$(wc -l < proxy.txt)
    if [ $TOTAL -gt 10 ]; then
        echo -e "\n${BLUE}... và $((TOTAL - 10)) proxy khác${NC}"
    fi
}

gen_data() {
    seq $FIRST_PORT $LAST_PORT | while read port; do
        echo "usr$(random)/pass$(random)/$IP4/$port/$(gen64 $IP6)"
    done
}

gen_iptables() {
    cat <<EOF
$(awk -F "/" '{print "iptables -I INPUT -p tcp --dport " $4 " -m state --state NEW -j ACCEPT"}' ${WORKDATA})
EOF
}

gen_ifconfig() {
    cat <<EOF
$(awk -F "/" '{print "ip -6 addr add " $5 "/64 dev enp1s0"}' ${WORKDATA})
EOF
}

# ================================================================
# PHẦN 3: CẤU HÌNH ROUTING
# ================================================================

configure_warp_routing() {
    echo -e "\n${YELLOW}[6/8] Cấu hình routing qua WARP...${NC}"
    
    # Tạo routing table
    if ! grep -q "100 warp" /etc/iproute2/rt_tables 2>/dev/null; then
        echo "100 warp" >> /etc/iproute2/rt_tables
    fi
    
    # Tìm WARP interface
    echo -e "${BLUE}Tìm CloudflareWARP interface...${NC}"
    for i in {1..15}; do
        WARP_IF=$(ip -o link show 2>/dev/null | grep -i cloudflare | awk -F': ' '{print $2}' | head -1)
        if [ -n "$WARP_IF" ]; then
            break
        fi
        sleep 2
    done
    
    if [ -n "$WARP_IF" ]; then
        echo -e "${GREEN}✅ Interface: ${WARP_IF}${NC}"
        
        # Setup routing
        ip -6 route add default dev $WARP_IF table warp 2>/dev/null
        ip -6 rule add from ${IP6}::/64 table warp priority 100 2>/dev/null
        ip -4 route add default dev $WARP_IF table warp 2>/dev/null
        
        echo -e "${GREEN}✅ Routing đã cấu hình${NC}"
    else
        echo -e "${YELLOW}⚠️  Chưa tìm thấy interface (WARP có thể chưa sẵn sàng)${NC}"
    fi
    
    # Tạo script routing
    cat > /usr/local/bin/setup-warp-routing.sh <<'SCRIPT'
#!/bin/bash
for i in {1..30}; do
    if warp-cli status 2>&1 | grep -qi "Connected"; then
        break
    fi
    sleep 1
done

for i in {1..20}; do
    WARP_IF=$(ip -o link show 2>/dev/null | grep -i cloudflare | awk -F': ' '{print $2}' | head -1)
    if [ -n "$WARP_IF" ]; then
        break
    fi
    sleep 2
done

if [ -n "$WARP_IF" ]; then
    IP6=$(curl -6 -s --connect-timeout 5 icanhazip.com 2>/dev/null | cut -f1-4 -d':')
    ip -6 route add default dev $WARP_IF table warp 2>/dev/null
    ip -6 rule add from ${IP6}::/64 table warp priority 100 2>/dev/null
    ip -4 route add default dev $WARP_IF table warp 2>/dev/null
    logger "WARP routing configured: $WARP_IF"
else
    logger "WARP interface not found"
fi
SCRIPT
    
    chmod +x /usr/local/bin/setup-warp-routing.sh
}

# ================================================================
# PHẦN 4: TẠO SERVICES
# ================================================================

create_warp_service() {
    echo -e "\n${YELLOW}[7/8] Tạo systemd services...${NC}"
    
    cat >/etc/systemd/system/cloudflare-warp-autoconnect.service <<EOF
[Unit]
Description=Cloudflare WARP Auto-connect
Before=3proxy.service
After=network.target warp-svc.service
Requires=warp-svc.service

[Service]
Type=oneshot
ExecStartPre=/bin/sleep 5
ExecStart=/usr/bin/warp-cli connect
ExecStartPost=/bin/sleep 10
ExecStartPost=/usr/local/bin/setup-warp-routing.sh
RemainAfterExit=yes
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

    systemctl daemon-reload
    systemctl enable warp-svc >/dev/null 2>&1
    systemctl enable cloudflare-warp-autoconnect.service >/dev/null 2>&1
    
    echo -e "${GREEN}✅ Services đã tạo${NC}"
}

# ================================================================
# MAIN EXECUTION
# ================================================================

echo -e "\n${YELLOW}[0/8] Cài đặt gói cần thiết...${NC}"
if [ -f /etc/redhat-release ]; then
    yum -y install gcc net-tools bsdtar zip curl expect >/dev/null 2>&1
else
    apt-get update -qq
    apt-get install -y gcc net-tools bsdtar zip curl expect >/dev/null 2>&1
fi
echo -e "${GREEN}✅ Đã cài đặt${NC}"

# Cài WARP
install_cloudflare_warp
configure_cloudflare_warp

# Cài 3proxy
install_3proxy

# Setup
echo -e "\n${YELLOW}[4/8] Thiết lập...${NC}"
WORKDIR="/home/proxy-installer"
WORKDATA="${WORKDIR}/data.txt"
mkdir -p $WORKDIR && cd $_

IP4=$(curl -4 -s icanhazip.com)
IP6=$(curl -6 -s icanhazip.com | cut -f1-4 -d':')

echo -e "${BLUE}VPS IP:${NC}"
echo -e "  IPv4: ${GREEN}${IP4}${NC}"
echo -e "  IPv6: ${GREEN}${IP6}${NC}"

echo -e "\n${YELLOW}Nhập số lượng proxy (ví dụ: 500):${NC}"
read COUNT

FIRST_PORT=10000
LAST_PORT=$(($FIRST_PORT + $COUNT - 1))

echo -e "\n${YELLOW}[5/8] Tạo cấu hình proxy...${NC}"
gen_data >$WORKDIR/data.txt
gen_iptables >$WORKDIR/boot_iptables.sh
gen_ifconfig >$WORKDIR/boot_ifconfig.sh
chmod +x ${WORKDIR}/boot_*.sh

gen_3proxy >/usr/local/etc/3proxy/3proxy.cfg

echo "* soft nofile 65535" >> /etc/security/limits.conf
echo "* hard nofile 65535" >> /etc/security/limits.conf

# Tạo 3proxy service
cat >/etc/systemd/system/3proxy.service <<EOF
[Unit]
Description=3proxy tiny proxy server
After=network.target cloudflare-warp-autoconnect.service
Wants=cloudflare-warp-autoconnect.service

[Service]
Type=forking
ExecStart=/usr/local/etc/3proxy/bin/3proxy /usr/local/etc/3proxy/3proxy.cfg
ExecStop=/bin/kill -TERM \$MAINPID
RemainAfterExit=yes
Restart=always
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable 3proxy >/dev/null 2>&1

echo -e "${GREEN}✅ Cấu hình hoàn tất${NC}"

# Routing và services
configure_warp_routing
create_warp_service

# Khởi động
echo -e "\n${YELLOW}[8/8] Khởi động dịch vụ...${NC}"

if ! warp-cli status 2>&1 | grep -qi "Connected"; then
    systemctl start cloudflare-warp-autoconnect.service
    sleep 5
fi

bash ${WORKDIR}/boot_iptables.sh 2>/dev/null
bash ${WORKDIR}/boot_ifconfig.sh 2>/dev/null

if command -v firewall-cmd >/dev/null 2>&1; then
    echo -e "${BLUE}Cấu hình firewall...${NC}"
    for port in $(seq $FIRST_PORT $LAST_PORT); do
        firewall-cmd --permanent --add-port=${port}/tcp 2>/dev/null
    done
    firewall-cmd --reload 2>/dev/null
fi

gen_proxy_file_for_user
systemctl start 3proxy
sleep 3

print_proxy

# ================================================================
# KIỂM TRA
# ================================================================

echo -e "\n${YELLOW}============================================${NC}"
echo -e "${YELLOW}  KIỂM TRA TRẠNG THÁI${NC}"
echo -e "${YELLOW}============================================${NC}"

if warp-cli status 2>&1 | grep -qi "Connected"; then
    echo -e "${GREEN}✅ WARP: Hoạt động${NC}"
    WARP_OK=true
else
    echo -e "${RED}❌ WARP: Chưa kết nối${NC}"
    WARP_OK=false
fi

if systemctl is-active --quiet 3proxy; then
    echo -e "${GREEN}✅ 3proxy: Đang chạy${NC}"
else
    echo -e "${RED}❌ 3proxy: Lỗi${NC}"
fi

# Test proxy
echo -e "\n${BLUE}Test proxy mẫu...${NC}"
TEST_PROXY=$(head -1 proxy.txt)
TEST_RESULT=$(timeout 10 curl -x socks5://${TEST_PROXY} -s https://api.ipify.org 2>/dev/null)

if [ -n "$TEST_RESULT" ]; then
    echo -e "${GREEN}✅ Proxy hoạt động: IP = ${TEST_RESULT}${NC}"
    if [ "$TEST_RESULT" != "$IP4" ]; then
        echo -e "${GREEN}✅ IP khác VPS → Đang qua WARP${NC}"
    else
        echo -e "${YELLOW}⚠️  IP = VPS → WARP chưa routing${NC}"
    fi
else
    echo -e "${YELLOW}⚠️  Không test được (thử sau vài phút)${NC}"
fi

# ================================================================
# HƯỚNG DẪN
# ================================================================

echo -e "\n${GREEN}============================================${NC}"
echo -e "${GREEN}  HOÀN TẤT!${NC}"
echo -e "${GREEN}============================================${NC}"

cat > ${WORKDIR}/HUONG-DAN.txt <<EOF
================================================
  HƯỚNG DẪN SỬ DỤNG
================================================

FILE PROXY: ${WORKDIR}/proxy.txt
Số lượng: ${COUNT} proxy
Port: ${FIRST_PORT} - ${LAST_PORT}

TEST PROXY:
  curl -x socks5://${TEST_PROXY} https://api.ipify.org

KIỂM TRA WARP:
  warp-cli status

NẾU WARP KHÔNG HOẠT ĐỘNG:
  1. warp-cli disconnect
  2. warp-cli registration delete
  3. systemctl restart warp-svc
  4. warp-cli registration new  (nhập 'y' khi hỏi)
  5. warp-cli mode warp
  6. warp-cli connect
  7. systemctl restart cloudflare-warp-autoconnect
  8. systemctl restart 3proxy

LOGS:
  - WARP: journalctl -u cloudflare-warp-autoconnect -f
  - 3proxy: journalctl -u 3proxy -f

================================================
EOF

echo -e "${YELLOW}File hướng dẫn: ${WORKDIR}/HUONG-DAN.txt${NC}"

if [ "$WARP_OK" = false ]; then
    echo -e "\n${YELLOW}⚠️  CẢNH BÁO: WARP chưa kết nối${NC}"
    echo -e "${YELLOW}Proxy vẫn hoạt động nhưng chưa qua Cloudflare${NC}"
    echo -e "${YELLOW}Để kết nối WARP:${NC}"
    echo -e "${BLUE}warp-cli registration new${NC} ${YELLOW}(nhập 'y')${NC}"
    echo -e "${BLUE}warp-cli mode warp${NC}"
    echo -e "${BLUE}warp-cli connect${NC}"
    echo -e "${BLUE}systemctl restart 3proxy${NC}"
fi

echo -e "\n${GREEN}✅ Script hoàn tất!${NC}"

#!/bin/bash
# ================================================================
# Script: 3proxy IPv6 + Cloudflare WARP Layer
# M·ª•c ƒë√≠ch: T·∫°o proxy IPv6 nh∆∞ script g·ªëc + th√™m l·ªõp WARP che ch·∫Øn
# ================================================================

# Ki·ªÉm tra quy·ªÅn root
if [ "$(id -u)" != "0" ]; then
    echo "This script must be run as root" 1>&2
    exit 1
fi

# ================================================================
# PH·∫¶N 1: C√ÅC H√ÄM G·ªêC (GI·ªÆ NGUY√äN 100%)
# ================================================================

random() {
    tr </dev/urandom -dc A-Za-z0-9 | head -c8
    echo
}

array=(1 2 3 4 5 6 7 8 9 0 a b c d e f)
gen64() {
    ip64() {
        echo "${array[$RANDOM % 16]}${array[$RANDOM % 16]}${array[$RANDOM % 16]}${array[$RANDOM % 16]}"
    }
    echo "$1:$(ip64):$(ip64):$(ip64):$(ip64)"
}

install_3proxy() {
    echo "Installing 3proxy"
    URL="https://raw.githubusercontent.com/quayvlog/quayvlog/main/3proxy-3proxy-0.8.6.tar.gz"
    wget -qO- $URL | bsdtar -xvf-
    cd 3proxy-3proxy-0.8.6
    make -f Makefile.Linux
    mkdir -p /usr/local/etc/3proxy/{bin,logs,stat}
    cp src/3proxy /usr/local/etc/3proxy/bin/
    cd $WORKDIR
}

# ================================================================
# PH·∫¶N 2: TH√äM H√ÄM C·∫§U H√åNH 3PROXY M·ªöI (C√ì WARP)
# ================================================================

gen_3proxy() {
    cat <<EOF
daemon
maxconn 2000
nscache 65535
timeouts 1 5 30 60 180 1800 15 60
setgid 65535
setuid 65535
flush

# ============================================
# TH√äM WARP PARENT PROXY (L·ªõp trung gian)
# ============================================
parent 1000 socks5 127.0.0.1 40000

auth strong

users $(awk -F "/" 'BEGIN{ORS="";} {print $1 ":CL:" $2 " "}' ${WORKDATA})

$(awk -F "/" '{print "auth strong\nallow " $1 "\nparent 1000\nproxy -6 -n -a -p" $4 " -i" $3 " -e"$5 "\nflush\n"}' ${WORKDATA})
EOF
}

gen_proxy_file_for_user() {
    cat >proxy.txt <<EOF
$(awk -F "/" '{print $3 ":" $4 ":" $1 ":" $2 }' ${WORKDATA})
EOF
}

print_proxy() {
    echo "Proxy is ready! Format IP:PORT:LOGIN:PASS"
    echo "Here are your proxy details:"
    cat proxy.txt
}

gen_data() {
    seq $FIRST_PORT $LAST_PORT | while read port; do
        echo "usr$(random)/pass$(random)/$IP4/$port/$(gen64 $IP6)"
    done
}

gen_iptables() {
    cat <<EOF
$(awk -F "/" '{print "iptables -I INPUT -p tcp --dport " $4 " -m state --state NEW -j ACCEPT"}' ${WORKDATA})
EOF
}

gen_ifconfig() {
    cat <<EOF
$(awk -F "/" '{print "ip -6 addr add " $5 "/64 dev enp1s0"}' ${WORKDATA})
EOF
}

# ================================================================
# PH·∫¶N 3: C√ÄI ƒê·∫∂T CLOUDFLARE WARP (TH√äM M·ªöI)
# ================================================================

install_cloudflare_warp() {
    echo "=========================================="
    echo "  INSTALLING CLOUDFLARE WARP"
    echo "=========================================="
    
    if [ -f /etc/redhat-release ]; then
        # CentOS/RHEL
        echo "Detected CentOS/RHEL system"
        curl -fsSL https://pkg.cloudflareclient.com/cloudflare-warp-ascii.repo | tee /etc/yum.repos.d/cloudflare-warp.repo
        yum install -y cloudflare-warp
    else
        # Ubuntu/Debian
        echo "Detected Ubuntu/Debian system"
        curl -fsSL https://pkg.cloudflareclient.com/pubkey.gpg | gpg --dearmor -o /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg
        echo "deb [arch=amd64 signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] https://pkg.cloudflareclient.com/ $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/cloudflare-client.list
        apt-get update
        apt-get install -y cloudflare-warp
    fi
    
    echo "‚úÖ WARP installed successfully"
}

configure_warp() {
    echo "=========================================="
    echo "  CONFIGURING WARP PROXY"
    echo "=========================================="
    
    # Kh·ªüi ƒë·ªông service
    systemctl enable warp-svc
    systemctl restart warp-svc
    sleep 5
    
    # X√≥a registration c≈© (n·∫øu c√≥)
    warp-cli disconnect 2>/dev/null
    warp-cli registration delete 2>/dev/null
    sleep 2
    
    # ƒêƒÉng k√Ω WARP
    echo "Registering WARP..."
    yes | warp-cli registration new 2>/dev/null || warp-cli registration new
    sleep 3
    
    # ƒê·∫∑t ch·∫ø ƒë·ªô PROXY (quan tr·ªçng!)
    echo "Setting WARP to proxy mode..."
    warp-cli mode proxy
    sleep 2
    
    # Connect ƒë·ªÉ m·ªü port 40000
    echo "Connecting WARP..."
    warp-cli connect
    sleep 10
    
    # Ki·ªÉm tra port 40000
    echo "Checking WARP proxy port..."
    for i in {1..15}; do
        if netstat -tuln 2>/dev/null | grep -q ":40000" || ss -tuln 2>/dev/null | grep -q ":40000"; then
            echo "‚úÖ WARP proxy is ACTIVE on port 40000"
            
            # Test IP qua WARP
            WARP_IP=$(curl -x socks5://127.0.0.1:40000 -s --connect-timeout 10 https://api.ipify.org 2>/dev/null)
            if [ -n "$WARP_IP" ]; then
                echo "‚úÖ IP through WARP: ${WARP_IP}"
            fi
            return 0
        fi
        echo "‚è≥ Waiting for WARP proxy... (attempt $i/15)"
        sleep 3
    done
    
    echo "‚ö†Ô∏è  WARNING: WARP proxy not detected on port 40000"
    echo "Proxies will work but WITHOUT Cloudflare protection"
}

create_warp_systemd_service() {
    echo "Creating WARP auto-start service..."
    
    cat >/etc/systemd/system/cloudflare-warp-proxy.service <<'EOF'
[Unit]
Description=Cloudflare WARP Proxy Mode
Before=3proxy.service
After=network.target warp-svc.service
Requires=warp-svc.service

[Service]
Type=oneshot
ExecStart=/bin/bash -c '/usr/bin/warp-cli mode proxy && sleep 3 && /usr/bin/warp-cli connect'
ExecStartPost=/bin/sleep 10
RemainAfterExit=yes
Restart=on-failure
RestartSec=15

[Install]
WantedBy=multi-user.target
EOF

    systemctl daemon-reload
    systemctl enable cloudflare-warp-proxy.service
    echo "‚úÖ WARP service created"
}

# ================================================================
# PH·∫¶N 4: MAIN SCRIPT (GI·ªÆ NGUY√äN LOGIC G·ªêC + TH√äM WARP)
# ================================================================

echo "=========================================="
echo "  3PROXY IPv6 + CLOUDFLARE WARP"
echo "=========================================="
echo ""
echo "‚ö†Ô∏è  This script will:"
echo "1. Install 3proxy with IPv6 support (original script)"
echo "2. Install Cloudflare WARP as protection layer"
echo "3. Route traffic: Client ‚Üí 3proxy ‚Üí WARP ‚Üí Internet"
echo ""
read -p "Press Enter to continue..."

# C√†i ƒë·∫∑t c√°c g√≥i c·∫ßn thi·∫øt
echo "Installing required packages"
if [ -f /etc/redhat-release ]; then
    yum -y install gcc net-tools bsdtar zip curl expect >/dev/null
else
    apt-get update -qq
    apt-get install -y gcc net-tools bsdtar zip curl expect >/dev/null
fi

# C√†i ƒë·∫∑t Cloudflare WARP (TH√äM M·ªöI)
install_cloudflare_warp
configure_warp
create_warp_systemd_service

# C√†i ƒë·∫∑t 3proxy (GI·ªÆ NGUY√äN)
install_3proxy

echo "Working folder = /home/proxy-installer"
WORKDIR="/home/proxy-installer"
WORKDATA="${WORKDIR}/data.txt"
mkdir -p $WORKDIR && cd $_

IP4=$(curl -4 -s icanhazip.com)
IP6=$(curl -6 -s icanhazip.com | cut -f1-4 -d':')

echo "Internal IP = ${IP4}. External subnet for IPv6 = ${IP6}"

echo "How many proxies do you want to create? Example: 500"
read COUNT

FIRST_PORT=10000
LAST_PORT=$(($FIRST_PORT + $COUNT - 1))

# T·∫°o data v√† c·∫•u h√¨nh (GI·ªÆ NGUY√äN)
gen_data >$WORKDIR/data.txt
gen_iptables >$WORKDIR/boot_iptables.sh
gen_ifconfig >$WORKDIR/boot_ifconfig.sh
chmod +x ${WORKDIR}/boot_*.sh

# T·∫°o c·∫•u h√¨nh 3proxy (S·ª¨ D·ª§NG H√ÄM M·ªöI C√ì WARP)
gen_3proxy >/usr/local/etc/3proxy/3proxy.cfg

echo "* soft nofile 65535" >> /etc/security/limits.conf
echo "* hard nofile 65535" >> /etc/security/limits.conf

# T·∫°o systemd service cho 3proxy (GI·ªÆ NGUY√äN + TH√äM DEPENDENCY)
cat >/etc/systemd/system/3proxy.service <<EOF
[Unit]
Description=3proxy tiny proxy server
After=network.target cloudflare-warp-proxy.service
Wants=cloudflare-warp-proxy.service

[Service]
Type=forking
ExecStart=/usr/local/etc/3proxy/bin/3proxy /usr/local/etc/3proxy/3proxy.cfg
ExecStop=/bin/kill -TERM \$MAINPID
RemainAfterExit=yes
Restart=always
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable 3proxy

# Kh·ªüi ƒë·ªông WARP tr∆∞·ªõc (TH√äM M·ªöI)
echo "Starting WARP service..."
systemctl start cloudflare-warp-proxy.service
sleep 5

# √Åp d·ª•ng c·∫•u h√¨nh iptables v√† ifconfig (GI·ªÆ NGUY√äN)
bash ${WORKDIR}/boot_iptables.sh
bash ${WORKDIR}/boot_ifconfig.sh

# C·∫•u h√¨nh firewall (GI·ªÆ NGUY√äN)
if command -v firewall-cmd >/dev/null 2>&1; then
    for port in $(seq $FIRST_PORT $LAST_PORT); do
        firewall-cmd --permanent --add-port=${port}/tcp 2>/dev/null
    done
    firewall-cmd --reload
fi

# T·∫°o file proxy cho user (GI·ªÆ NGUY√äN)
gen_proxy_file_for_user

print_proxy

# Kh·ªüi ƒë·ªông 3proxy (GI·ªÆ NGUY√äN)
systemctl start 3proxy

echo "3proxy has been installed and configured. Check /usr/local/etc/3proxy/logs/3proxy.log for logs."
echo "You can check the status of 3proxy by running: systemctl status 3proxy"

if systemctl is-active --quiet 3proxy; then
    echo "‚úÖ 3proxy is running."
else
    echo "‚ùå 3proxy failed to start. Check the logs with: journalctl -u 3proxy"
fi

# ================================================================
# PH·∫¶N 5: KI·ªÇM TRA K·∫æT QU·∫¢
# ================================================================

echo ""
echo "=========================================="
echo "  FINAL CHECKS"
echo "=========================================="

# Ki·ªÉm tra WARP
echo "1. Checking WARP proxy..."
if netstat -tuln 2>/dev/null | grep -q ":40000" || ss -tuln 2>/dev/null | grep -q ":40000"; then
    echo "   ‚úÖ WARP proxy: ACTIVE"
    WARP_STATUS="ACTIVE"
else
    echo "   ‚ö†Ô∏è  WARP proxy: NOT ACTIVE"
    WARP_STATUS="INACTIVE"
fi

# Ki·ªÉm tra 3proxy
echo "2. Checking 3proxy..."
if systemctl is-active --quiet 3proxy; then
    echo "   ‚úÖ 3proxy: RUNNING"
else
    echo "   ‚ùå 3proxy: FAILED"
fi

# Test proxy th·ª±c t·∫ø
echo "3. Testing actual proxy connection..."
TEST_PROXY=$(head -1 proxy.txt | awk -F':' '{print $1":"$2":"$3":"$4}')

if [ -n "$TEST_PROXY" ]; then
    echo "   Testing: ${TEST_PROXY}"
    
    for i in {1..3}; do
        TEST_RESULT=$(timeout 15 curl -x socks5://${TEST_PROXY} -s https://api.ipify.org 2>/dev/null)
        
        if [ -n "$TEST_RESULT" ]; then
            echo "   ‚úÖ Test $i: IP = ${TEST_RESULT}"
            
            if [ "$TEST_RESULT" != "$IP4" ]; then
                echo "   ‚úÖ IP is DIFFERENT from VPS ‚Üí Traffic going through Cloudflare!"
            else
                echo "   ‚ö†Ô∏è  IP same as VPS ‚Üí WARP not working"
            fi
            break
        else
            if [ $i -lt 3 ]; then
                echo "   ‚è≥ Test $i timeout, retrying..."
                sleep 3
            else
                echo "   ‚ö†Ô∏è  All tests timed out"
            fi
        fi
    done
fi

# ================================================================
# PH·∫¶N 6: T·∫†O H∆Ø·ªöNG D·∫™N S·ª¨ D·ª§NG
# ================================================================

cat > ${WORKDIR}/INSTRUCTIONS.txt <<EOF
========================================
  3PROXY + CLOUDFLARE WARP
========================================

PROXY FILE: ${WORKDIR}/proxy.txt
Number of proxies: ${COUNT}
Port range: ${FIRST_PORT} - ${LAST_PORT}

ARCHITECTURE:
  Client 
    ‚Üì
  3proxy (port ${FIRST_PORT}+)
    ‚Üì
  WARP Proxy (127.0.0.1:40000)
    ‚Üì
  Cloudflare Network
    ‚Üì
  Internet

WARP STATUS: ${WARP_STATUS}

HOW TO CHECK IF WARP IS WORKING:
  netstat -tuln | grep 40000
  (Should see: 127.0.0.1:40000 LISTEN)

TEST PROXY:
  curl -x socks5://${TEST_PROXY} https://api.ipify.org
  (IP should be DIFFERENT from ${IP4})

TEST WARP DIRECTLY:
  curl -x socks5://127.0.0.1:40000 https://api.ipify.org

IF WARP NOT WORKING:
  systemctl restart warp-svc
  warp-cli mode proxy
  warp-cli connect
  sleep 10
  netstat -tuln | grep 40000
  systemctl restart 3proxy

CHECK LOGS:
  journalctl -u 3proxy -f
  journalctl -u warp-svc -f
  warp-cli status

SERVICES:
  systemctl status 3proxy
  systemctl status warp-svc
  systemctl status cloudflare-warp-proxy

========================================
EOF

echo ""
echo "=========================================="
echo "  ‚úÖ INSTALLATION COMPLETE!"
echo "=========================================="
echo ""
echo "üìÅ Proxy file: ${WORKDIR}/proxy.txt"
echo "üìñ Instructions: ${WORKDIR}/INSTRUCTIONS.txt"
echo ""

if [ "$WARP_STATUS" = "ACTIVE" ]; then
    echo "‚úÖ SUCCESS: Proxies are protected by Cloudflare WARP"
else
    echo "‚ö†Ô∏è  WARNING: WARP not active. Proxies work but WITHOUT Cloudflare protection"
    echo ""
    echo "To fix WARP:"
    echo "  systemctl restart warp-svc && warp-cli mode proxy && warp-cli connect"
    echo "  Wait 10 seconds, then: systemctl restart 3proxy"
fi

echo ""
echo "=========================================="
